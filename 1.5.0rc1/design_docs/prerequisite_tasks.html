<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prerequisite Tasks and Subtasks &mdash; MPAS-Analysis 1.5.0rc1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Eddy Kinetic Energy Climatology Mapping" href="eddykineticenergy.html" />
    <link rel="prev" title="Remapper for “online” remapping of data sets" href="remapper.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MPAS-Analysis
          </a>
              <div class="version">
                1.5.0rc1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analysis_tasks.html">Analysis Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components.html">MPAS Components and E3SM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observations.html">Observations</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../design_docs.html">Design Documents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="generalized_horizontal_interpolation.html">Generalized Horizontal Interpolation in MPAS-Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_file_reorganization.html">Config File Reorganization</a></li>
<li class="toctree-l2"><a class="reference internal" href="timekeeping_reorg.html">Reorganize Timekeeping</a></li>
<li class="toctree-l2"><a class="reference internal" href="generalize_calendar.html">Generalize Calendar supported by Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="variable_mapping_reorg.html">Moving variable mapping outside of mpas_xarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel_tasks.html">Support Parallel Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="remapper.html">Remapper for “online” remapping of data sets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Prerequisite Tasks and Subtasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="eddykineticenergy.html">Eddy Kinetic Energy Climatology Mapping</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Main Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html#contributors">Contributors</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MPAS-Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../design_docs.html">Design Documents</a> &raquo;</li>
      <li>Prerequisite Tasks and Subtasks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/design_docs/prerequisite_tasks.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="prerequisite-tasks-and-subtasks">
<h1>Prerequisite Tasks and Subtasks<a class="headerlink" href="#prerequisite-tasks-and-subtasks" title="Permalink to this headline">¶</a></h1>
<h2>
Xylar Asay-Davis <br>
date: 2017/06/12 <br>
</h2><h3> Summary </h3><p>Currently, no tasks depend on other tasks to run.  However, in order to allow
multiple plots to be generated simulataneously, it is desirable to break tasks
into multiple subtasks, and some of these subtasks will need rely on data from
other subtasks.  It is also conceivable that multiple tasks could rely on the
same data (e.g. a common climatology dataset). The proposed solution to this
problem is to allow “prerequisite tasks” to a given analysis task.  The task
will only run after the prerequisite task(s) have completed.  Prerequisite
tasks could be used to build up a sequence of analysis tasks in several steps.
Some of these steps could be shared between analysis tasks (e.g. computing
single data set and then plotting it in various ways).  Implementation of this
design will be considered a success if dependent tasks only run once their
prerequisite tasks have completed successfully.</p>
<h2> Requirements </h2><h3> Requirement: Define prerequisite tasks <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>A simple mechanism (such as a list of task names) exists to define prerequisite
tasks of each analysis task.</p>
<h3> Requirement: Add prerequisites to task list <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>Given a task that we want to run, a mechanism must exist for adding its
prerequisites (if any) to the list of tasks to be run.</p>
<h3> Requirement: Holding dependent tasks <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>Dependent tasks (those with prerequisites) must be prevented from running until
their prerequisites have successfully finished.</p>
<h3> Requirement: Cancel dependents of failed prerequisites <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>If a prerequisite of a dependent tasks has failed, the dependent task should
not be run.</p>
<h2> Algorithmic Formulations </h2><h3> Design solution: Define prerequisite tasks <br>
Date last modified: 2017/09/19 <br>
Contributors: Xylar Asay-Davis
</h3><p>Each task will be constructed with a list of the names of prerequisite tasks.
If a task has no prerequisites (the default), the list is empty.</p>
<h3> Design solution: Add prerequisites to task list <br>
Date last modified: 2017/10/11 <br>
Contributors: Xylar Asay-Davis
</h3><p>A recursive function will be used to add a given task (assuming its
<code class="docutils literal notranslate"><span class="pre">check_generate</span></code> method returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, meaning that task should be generated)
and its dependencies to a list of analyses to run.  The code (with a few
error messages removed for brevity) is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">analysesToGenerate</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># check which analysis we actually want to generate and only keep those</span>
<span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="p">:</span>
    <span class="c1"># update the dictionary with this task and perhaps its subtasks</span>
    <span class="n">add_task_and_subtasks</span><span class="p">(</span><span class="n">analysisTask</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_task_and_subtasks</span><span class="p">(</span><span class="n">analysisTask</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span>
                          <span class="n">callCheckGenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analysesToGenerate</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">callCheckGenerate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">check_generate</span><span class="p">():</span>
        <span class="c1"># we don&#39;t need to add this task -- it wasn&#39;t requested</span>
        <span class="k">return</span>

    <span class="c1"># first, we should try to add the prerequisites of this task and its</span>
    <span class="c1"># subtasks (if they aren&#39;t also subtasks for this task)</span>
    <span class="n">prereqs</span> <span class="o">=</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">runAfterTasks</span>
    <span class="k">for</span> <span class="n">subtask</span> <span class="ow">in</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">prereq</span> <span class="ow">in</span> <span class="n">subtask</span><span class="o">.</span><span class="n">runAfterTasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prereq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
                <span class="n">prereqs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subtask</span><span class="o">.</span><span class="n">runAfterTasks</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prereq</span> <span class="ow">in</span> <span class="n">prereqs</span><span class="p">:</span>
        <span class="n">add_task_and_subtasks</span><span class="p">(</span><span class="n">prereq</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span>
                              <span class="n">callCheckGenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prereq</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="c1"># this task should also not run</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
            <span class="k">return</span>

    <span class="c1"># make sure all prereqs have been set up successfully before trying to</span>
    <span class="c1"># set up this task -- this task&#39;s setup may depend on setup in the prereqs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">analysisTask</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
        <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
        <span class="k">return</span>

    <span class="c1"># next, we should try to add the subtasks.  This is done after the current</span>
    <span class="c1"># analysis task has been set up in case subtasks depend on information</span>
    <span class="c1"># from the parent task</span>
    <span class="k">for</span> <span class="n">subtask</span> <span class="ow">in</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
        <span class="n">add_task_and_subtasks</span><span class="p">(</span><span class="n">subtask</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span>
                              <span class="n">callCheckGenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subtask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
            <span class="k">return</span>

    <span class="n">analysesToGenerate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analysisTask</span><span class="p">)</span>
    <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
</pre></div>
</div>
<h3> Design solution: Holding dependent tasks <br>
Date last modified: 2017/10/11 <br>
Contributors: Xylar Asay-Davis
</h3><p>Each task is given a <code class="docutils literal notranslate"><span class="pre">_runStatus</span></code> attribute, which is a <code class="docutils literal notranslate"><span class="pre">multiprocessing.Value</span></code>
object that can be shared and changed across processes.  A set of constant
possible values for this attribute, <code class="docutils literal notranslate"><span class="pre">READY</span></code>, <code class="docutils literal notranslate"><span class="pre">BLOCKED</span></code>, <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code>, <code class="docutils literal notranslate"><span class="pre">SUCCES</span></code> and
<code class="docutils literal notranslate"><span class="pre">FAIL</span></code> are defined in<code class="docutils literal notranslate"><span class="pre">AnalysisTask</span></code>.  If a task has no prerequisites, initially
<code class="docutils literal notranslate"><span class="pre">_runStatus</span> <span class="pre">=</span> <span class="pre">READY</span></code>; otherwise <code class="docutils literal notranslate"><span class="pre">_runStatus</span> <span class="pre">=</span> <span class="pre">BLOCKED</span></code>.  Any <code class="docutils literal notranslate"><span class="pre">READY</span></code>
task can be run (<code class="docutils literal notranslate"><span class="pre">_runStatus</span> <span class="pre">=</span> <span class="pre">'running'</span></code>).  Any task that finishes is given
<code class="docutils literal notranslate"><span class="pre">_runStatus</span> <span class="pre">=</span> <span class="pre">SUCCESS</span></code> or <code class="docutils literal notranslate"><span class="pre">_runStatus</span> <span class="pre">=</span> <span class="pre">FAIL</span></code> (I know, not grammatically
consistent but compact…).</p>
<p>When a new parallel slot becomes available, all <code class="docutils literal notranslate"><span class="pre">BLOCKED</span></code> tasks are checked
to see if any prerequisites have failed (in which case the task also fails) or
if all prerequisites have succeeded, in which case the task is now <code class="docutils literal notranslate"><span class="pre">READY</span></code>.
After that, the next <code class="docutils literal notranslate"><span class="pre">READY</span></code> task is run.</p>
<h3> Design solution: Cancel dependents of failed prerequisites <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>Same as above: When a new parallel slot becomes available, all <code class="docutils literal notranslate"><span class="pre">BLOCKED</span></code>
tasks are checked to see if any prerequisites have failed (in which case the
task also fails).</p>
<h2> Design and Implementation </h2><p>The design has been implemented in the branch
<a class="reference external" href="https://github.com/xylar/MPAS-Analysis/tree/add_mpas_climatology_task">xylar/add_mpas_climatology_task</a></p>
<h3> Implementation: Define prerequisite tasks <br>
Date last modified: 2017/10/11 <br>
Contributors: Xylar Asay-Davis
</h3><p><code class="docutils literal notranslate"><span class="pre">AnalysisTask</span></code> now has an attribute <code class="docutils literal notranslate"><span class="pre">runAfterTasks</span></code>, which default to empty.
Prerequisite tasks can be added by calling <code class="docutils literal notranslate"><span class="pre">run_after(self,</span> <span class="pre">task)</span></code> with the
task that this task should follow.</p>
<h3> Implementation: Add prerequisites to task list <br>
Date last modified: 2017/10/11 <br>
Contributors: Xylar Asay-Davis
</h3><p><code class="docutils literal notranslate"><span class="pre">build_analysis_list</span></code> in <code class="docutils literal notranslate"><span class="pre">run_mpas_analysis</span></code> has been modified to call a
recursive function <code class="docutils literal notranslate"><span class="pre">add_task_and_subtasks</span></code> that adds a task, its prerequisites
(if they have not already been added) and its subtasks to the list of tasks
to run.</p>
<h3> Implementation: Holding dependent tasks <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>The <code class="docutils literal notranslate"><span class="pre">run_analysis</span></code> function in <code class="docutils literal notranslate"><span class="pre">run_mpas_analysis</span></code> has been updated to be aware
of the status of each task, as described in the algorithms section.</p>
<h3> Implementation: Cancel dependents of failed prerequisites <br>
Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3><p>Again, the <code class="docutils literal notranslate"><span class="pre">run_analysis</span></code> function in <code class="docutils literal notranslate"><span class="pre">run_mpas_analysis</span></code> has been updated to
be aware of the status of each task, as described in the algorithms section.</p>
<p><span class="raw-html-m2r"><h2> Testing and Validation </h2></span></p>
<p><span class="raw-html-m2r"><h3> Date last modified: 2017/06/12 <br>
Contributors: Xylar Asay-Davis
</h3></span>
All plots will be tested to ensure they are bit-for-bit identical to
those produced by <code class="docutils literal notranslate"><span class="pre">develop</span></code> for all tests defined in the <code class="docutils literal notranslate"><span class="pre">configs/edison</span></code>
and <code class="docutils literal notranslate"><span class="pre">configs/lanl</span></code> directories.  Task will be run in parallel and I will
verify that no dependent tasks run before prerequisite tasks have completed.</p>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="remapper.html" class="btn btn-neutral float-left" title="Remapper for “online” remapping of data sets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="eddykineticenergy.html" class="btn btn-neutral float-right" title="Eddy Kinetic Energy Climatology Mapping" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright This software is open source software available under the BSD-3license. Copyright (c) 2020 Triad National Security, LLC. All rights reserved. Copyright (c) 2018 Lawrence Livermore National Security, LLC. All rights reserved. Copyright (c) 2018 UT-Battelle, LLC. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>