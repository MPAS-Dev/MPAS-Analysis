<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analysis Task Template &mdash; MPAS-Analysis 1.11.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=6cf1fb80"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Prerequisite Tasks and Subtasks" href="prerequisite_tasks.html" />
    <link rel="prev" title="Remapper for “online” remapping of data sets" href="remapper.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MPAS-Analysis
          </a>
              <div class="version">
                1.11.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/analysis_tasks.html">Analysis Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/components.html">MPAS Components and E3SM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/observations.html">Observations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/api.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design Documents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="generalized_horizontal_interpolation.html">Generalized Horizontal Interpolation in MPAS-Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_file_reorganization.html">Config File Reorganization</a></li>
<li class="toctree-l2"><a class="reference internal" href="timekeeping_reorg.html">Reorganize Timekeeping</a></li>
<li class="toctree-l2"><a class="reference internal" href="generalize_calendar.html">Generalize Calendar supported by Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="variable_mapping_reorg.html">Moving variable mapping outside of mpas_xarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel_tasks.html">Support Parallel Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="remapper.html">Remapper for “online” remapping of data sets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Analysis Task Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisite_tasks.html">Prerequisite Tasks and Subtasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="eddykineticenergy.html">Eddy Kinetic Energy Climatology Mapping</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/getting_started.html">User: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_getting_started.html">Developer: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_understand_a_task.html">Developers: Understanding an analysis task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_task.html">Developers: Adding a new analysis task</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Authors</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Main Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html#contributors">Contributors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MPAS-Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Design Documents</a></li>
      <li class="breadcrumb-item active">Analysis Task Template</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/design_docs/analysis_task_template.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="analysis-task-template">
<h1>Analysis Task Template<a class="headerlink" href="#analysis-task-template" title="Link to this heading">¶</a></h1>
<p><span class="raw-html-m2r"><h2>
Xylar Asay-Davis <br>
date: 2017/03/08 <br>
</h2></span></p>
<h3> Summary </h3><p>A new template python file for analysis tasks will be added to the repository.
The template will include a list of functions that each analysis task <em>must</em>
implement and example syntax for docstrings used to commend both the full
analysis task and the individual functions.</p>
<p>The existing analysis tasks will be updated to be consistent with this template.
The <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code> driver script will also be updated to work with the template.</p>
<p>The template is needed to:</p>
<ol class="arabic simple">
<li><p>serve as a starting point for writing new analysis tasks</p></li>
<li><p>ensure that tasks implement a standard set of
functions, making it easier to perform actions (such as checking whether
the task should be run, checking for required model and observations files,
purging files from a previous analysis run, and running the analysis) on
each analysis task in sequence (and, in the future, in parallel)</p></li>
<li><p>demonstrate the syntax and style of docstrings required to comment/document
each task and each function</p></li>
</ol>
<h3> Requirements </h3><h4> Requirement: Template for Analysis Tasks <br>
Date last modified: 2017/03/08 <br>
Contributors: Xylar Asay-Davis
</h4><p>The template should include each function that each analysis task <em>must</em> implement
and example docstring both for the task as a whole and for each funciton.</p>
<h4> Requirement: Validation within Analysis Tasks <br>
Date last modified: 2017/03/08 <br>
Contributors: Xylar Asay-Davis
</h4><p>Validation, such as checking config options or adding new ones if they are missing,
or checking if required data files are present, should be performed within a
function in each task (rather than in <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code>, as is sometimes the current
case).</p>
<h4> Requirement: Analysis Continues even when Analysis Task Fails <br>
Date last modified: 2017/03/08 <br>
Contributors: Xylar Asay-Davis
</h4><p>If validation fails, an error message should be printed but other analysis
tasks should be allowed to run.  Similarly, if a given analysis task raises
an exception, the error and stack trace should be printed but other analysis
tasks should still be run.</p>
<h4> Requirement: List of Tasks to Perform<br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>There should be a single place where new tasks are added to <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code>, as
is presently the case.  Yet, there should be a way to create a list of tasks to be
performed and later determine whether, when and how those tasks are to be run.
This capability also allows for operations like purging files from a prevous run
to be added in the future. The capability is also requried to allow for later task
parallelism. Currently, a task module is imported, there is a check to see if that
task should be run, and the task is performed in immediate sequence.</p>
<h3> Algorithmic Formulations (optional) </h3><h4> Design solution: Template for Analysis Tasks <br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>A base class, <code class="docutils literal notranslate"><span class="pre">AnalysisTask</span></code> will be added under <code class="docutils literal notranslate"><span class="pre">shared/analysis_task.py</span></code>.
This class will include methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: construct the task, including assigning variable and streams maps
(optional).</p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code><span class="classifier">performs common tasks to all analysis, such as reading</span></dt><dd><p>namelist and streams files</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">run</span></code>: the base class version does nothing</p></li>
</ul>
<p>The template will show how to set up a child class that decends from <code class="docutils literal notranslate"><span class="pre">AnalysisTask</span></code>.
It will show examples of:</p>
<ul>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">__init__</span></code><span class="classifier">construct the task, including assigning the <code class="docutils literal notranslate"><span class="pre">taskName</span></code>, <code class="docutils literal notranslate"><span class="pre">componentName</span></code></span></dt><dd><p>and <code class="docutils literal notranslate"><span class="pre">categories</span></code> of the analysis, and calling the base class’s constructor.</p>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code><span class="classifier">first, calls the base class’ version of <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code>, then,</span></dt><dd><p>determines if the configuration is valid for running this task (e.g. if
necessary files and config options are present)</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">run</span></code>: runs the analysis task</p></li>
</ul>
<p>The template will be located at:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpas_analysis/
<span class="w">    </span>-<span class="w"> </span>analysis_task_template.py
</pre></div>
</div>
<p>That is, it is the only file (other than <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>) in the base of the
<code class="docutils literal notranslate"><span class="pre">mpas_analysis</span></code> directory, making it easy to find.  This way, it will be the first
file most developers see when they look in <code class="docutils literal notranslate"><span class="pre">mpas_analysis</span></code> itself.</p>
<p>A reference to the template as the starting point for new developers will be added
to the readme.</p>
<h4> Design solution: Validation within Analysis Tasks <br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>The <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> method within each analysis task can be used to determine if
necessary input files are present and/or if config options are set as expected.
The template will provide examples of doing this.</p>
<p>Existing checks for missing observations files in <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code> will be
moved to individual analyses.  This will make clearer which checks correspond
with which analysis tasks and will make clearer where such checks should be added
within future analysis tasks.  Similarly, the addition of the <code class="docutils literal notranslate"><span class="pre">startDate</span></code> and
<code class="docutils literal notranslate"><span class="pre">endDate</span></code> config options will be moved to the corresponding analysis tasks.</p>
<h4> Design solution: Analysis Continues even when Analysis Task Fails <br>
Date last modified: 2017/03/08 <br>
Contributors: Xylar Asay-Davis
</h4><p>A try/except will be used around both <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code> calls to make sure
an error message and stack trace are printed, but execution will continue
for other tasks.</p>
<h4> Design solution: List of Tasks to Perform<br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>By having a common base class for all analysis tasks,
each task can be checked to see if it should be run based on
the <code class="docutils literal notranslate"><span class="pre">generate</span></code> command-line or config option.  If so, its <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code>
function will be run to make sure the configuration is right (and will
print a warning if not).  If <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> passes, the analysis can be added
to a list of functions to be run.  Later, a loop through the list
can be used to run each analysis.</p>
<p>Some analysis tasks require extra arguments (e.g. the field to be
analyzed in the case of <code class="docutils literal notranslate"><span class="pre">ocean.modelvsobs</span></code> and the streams and variable
maps for all analysis tasks).  These arguments will be passed to <code class="docutils literal notranslate"><span class="pre">__init__</span></code>
and stored as member variables that can later be accessed via <code class="docutils literal notranslate"><span class="pre">self.&lt;varName&gt;</span></code>.</p>
<h3> Design and Implementation </h3><p>Implementation is in the branch: <a class="reference external" href="https://github.com/xylar/MPAS-Analysis/tree/analysis_task_template">https://github.com/xylar/MPAS-Analysis/tree/analysis_task_template</a></p>
<h4> Implementation: Template for Analysis Tasks <br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>Here is the suggested base class <code class="docutils literal notranslate"><span class="pre">AnalysisTask</span></code> in full, intended to make discussion
of individual lines easier:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines the base class for analysis tasks.</span>

<span class="sd">Authors</span>
<span class="sd">-------</span>
<span class="sd">Xylar Asay-Davis</span>

<span class="sd">Last Modified</span>
<span class="sd">-------------</span>
<span class="sd">03/16/2017</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">..shared.io</span> <span class="kn">import</span> <span class="n">NameList</span><span class="p">,</span> <span class="n">StreamsFile</span>
<span class="kn">from</span> <span class="nn">..shared.io.utility</span> <span class="kn">import</span> <span class="n">build_config_full_path</span><span class="p">,</span> <span class="n">make_directories</span>


<span class="k">class</span> <span class="nc">AnalysisTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class for analysis tasks.</span>

<span class="sd">    Authors</span>
<span class="sd">    -------</span>
<span class="sd">    Xylar Asay-Davis</span>

<span class="sd">    Last Modified</span>
<span class="sd">    -------------</span>
<span class="sd">    03/16/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variableMap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the analysis task.</span>

<span class="sd">        Individual tasks (children classes of this base class) should first</span>
<span class="sd">        call this method to perform basic initialization, then, define the</span>
<span class="sd">        `taskName`, `componentName` and list of `categories` for the task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config :  instance of MpasAnalysisConfigParser</span>
<span class="sd">            Contains configuration options</span>

<span class="sd">        streamMap : dict, optional</span>
<span class="sd">            A dictionary of MPAS-O stream names that map to their mpas_analysis</span>
<span class="sd">            counterparts.</span>

<span class="sd">        variableMap : dict, optional</span>
<span class="sd">            A dictionary of MPAS-O variable names that map to their</span>
<span class="sd">            mpas_analysis counterparts.</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        Xylar Asay-Davis</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        03/16/2017</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streamMap</span> <span class="o">=</span> <span class="n">streamMap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variableMap</span> <span class="o">=</span> <span class="n">variableMap</span>  <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform steps to set up the analysis (e.g. reading namelists and</span>
<span class="sd">        streams files).</span>

<span class="sd">        After this call, the following member variables are set:</span>
<span class="sd">            self.inDirectory : the base input directory</span>
<span class="sd">            self.plotsDirectory : the directory for writing plots (which is</span>
<span class="sd">                also created if it doesn&#39;t exist)</span>
<span class="sd">            self.namelist : the namelist reader</span>
<span class="sd">            self.streams : the streams file reader</span>
<span class="sd">            self.calendar : the name of the calendar (&#39;gregorian&#39; or</span>
<span class="sd">                &#39;gregoraian_noleap&#39;)</span>

<span class="sd">        Individual tasks (children classes of this base class) should first</span>
<span class="sd">        call this method to perform basic setup, then, check whether the</span>
<span class="sd">        configuration is correct for a given analysis and perform additional,</span>
<span class="sd">        analysis-specific setup.  For example, this function could check if</span>
<span class="sd">        necessary observations and other data files are found, then, determine</span>
<span class="sd">        the list of files to be read when the analysis is run.</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        Xylar Asay-Davis</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        03/16/2017</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read parameters from config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;baseDirectory&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotsDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;plotsSubdirectory&#39;</span><span class="p">)</span>
        <span class="n">namelistFileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;oceanNamelistFileName&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span> <span class="o">=</span> <span class="n">NameList</span><span class="p">(</span><span class="n">namelistFileName</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inDirectory</span><span class="p">)</span>

        <span class="n">streamsFileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;oceanStreamsFileName&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streams</span> <span class="o">=</span> <span class="n">StreamsFile</span><span class="p">(</span><span class="n">streamsFileName</span><span class="p">,</span>
                                   <span class="n">streamsdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inDirectory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config_calendar_type&#39;</span><span class="p">)</span>

        <span class="n">make_directories</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotsDirectory</span><span class="p">)</span>
        <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the analysis task.</span>

<span class="sd">        Individual tasks (children classes of this base class) should first</span>
<span class="sd">        call this method to perform any common steps in an analysis task,</span>
<span class="sd">        then, perform the steps required to run the analysis task.</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        Xylar Asay-Davis</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        03/16/2017</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>  <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">check_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if this analysis should be generated, based on the</span>
<span class="sd">        `generate` config option and `taskName`, `componentName` and</span>
<span class="sd">        `categories`.</span>

<span class="sd">        Individual tasks do not need to create their own versions of this</span>
<span class="sd">        function.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        generate : bool</span>
<span class="sd">            Whether or not this task should be run.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError : If one of `self.taskName`, `self.componentName`</span>
<span class="sd">            or `self.categories` has not been set.</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        Xylar Asay-Davis</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        03/16/2017s</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">memberName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;taskName&#39;</span><span class="p">,</span> <span class="s1">&#39;componentName&#39;</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memberName</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Analysis tasks must define self.</span><span class="si">{}</span><span class="s1"> in their &#39;</span>
                                 <span class="s1">&#39;__init__ method.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memberName</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Analysis tasks</span><span class="se">\&#39;</span><span class="s1">s member self.categories &#39;</span>
                             <span class="s1">&#39;must be NOne or a list of strings.&#39;</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">generateList</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getExpression</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;generate&#39;</span><span class="p">)</span>
        <span class="n">generate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">generateList</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">element</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">allSuffixes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">componentName</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">allSuffixes</span> <span class="o">=</span> <span class="n">allSuffixes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span>
            <span class="n">noSuffixes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">taskName</span><span class="p">]</span> <span class="o">+</span> <span class="n">allSuffixes</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">allSuffixes</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">generate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">noSuffixes</span><span class="p">:</span>
                    <span class="n">generate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskName</span><span class="p">:</span>
                <span class="n">generate</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">generate</span>  <span class="c1"># }}}</span>
<span class="c1"># }}}</span>

<span class="c1"># vim: foldmethod=marker ai ts=4 sts=4 et sw=4 ft=python</span>
</pre></div>
</div>
<p>And here is the suggested template in full:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is an example analysis task to be used as a template for new tasks.</span>
<span class="sd">It should be copied into one of the component folders (`ocean`, `sea_ice`,</span>
<span class="sd">`land_ice`, etc.) and modified as needed.</span>

<span class="sd">Don&#39;t forget to remove this docstring. (It&#39;s not needed.)</span>

<span class="sd">Authors</span>
<span class="sd">-------</span>
<span class="sd">Xylar Asay-Davis</span>

<span class="sd">Last Modified</span>
<span class="sd">-------------</span>
<span class="sd">03/16/2017</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># import python modules here</span>

<span class="c1"># import mpas_analysis module here (those with relative paths starting with</span>
<span class="c1"># dots)</span>
<span class="kn">from</span> <span class="nn">..shared.analysis_task</span> <span class="kn">import</span> <span class="n">AnalysisTask</span>


<span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">AnalysisTask</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;Describe the analysis task here.&gt;</span>

<span class="sd">    Authors</span>
<span class="sd">    -------</span>
<span class="sd">    &lt;List of authors&gt;</span>

<span class="sd">    Last Modified</span>
<span class="sd">    -------------</span>
<span class="sd">    &lt;MM/DD/YYYY&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variableMap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">myArg</span><span class="o">=</span><span class="s1">&#39;myDefaultValue&#39;</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the analysis task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config :  instance of MpasAnalysisConfigParser</span>
<span class="sd">            Contains configuration options</span>

<span class="sd">        streamMap : dict, optional</span>
<span class="sd">            A dictionary of MPAS-O stream names that map to their mpas_analysis</span>
<span class="sd">            counterparts.</span>

<span class="sd">        variableMap : dict, optional</span>
<span class="sd">            A dictionary of MPAS-O variable names that map to their</span>
<span class="sd">            mpas_analysis counterparts.</span>

<span class="sd">        myNewArg : str, optional</span>
<span class="sd">            &lt;Describe the arg&gt;</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        &lt;List of authors&gt;</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        &lt;MM/DD/YYYY&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first, call the constructor from the base class (AnalysisTask)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="p">,</span> <span class="n">variableMap</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="p">,</span> <span class="n">variableMap</span><span class="p">)</span>

        <span class="c1"># next, name the task, the component (ocean, sea_ice, etc.) and the</span>
        <span class="c1"># categories (if any) of the component (&#39;timeSeries&#39;, &#39;climatologyMap&#39;</span>
        <span class="c1"># etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskName</span> <span class="o">=</span> <span class="s1">&#39;myTask&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">componentName</span> <span class="o">=</span> <span class="s1">&#39;component&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;category1&#39;</span><span class="p">,</span> <span class="s1">&#39;category2&#39;</span><span class="p">]</span>

        <span class="c1"># then, store any additional arguments for use later on.  These would</span>
        <span class="c1"># likely include things like the name of a field, region, month,</span>
        <span class="c1"># season, etc. to be analyzed so that the same subclass of AnalysisTask</span>
        <span class="c1"># can perform several different tasks (potentially in parallel)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myArg</span> <span class="o">=</span> <span class="n">myArg</span>
        <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform steps to set up the analysis and check for errors in the setup.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: if myArg has an invalid value</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        &lt;List of authors&gt;</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        &lt;MM/DD/YYYY&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first, call setup_and_check from the base class (AnalysisTask),</span>
        <span class="c1"># which will perform some common setup, including storing:</span>
        <span class="c1">#   self.inDirectory, self.plotsDirectory, self.namelist, self.streams</span>
        <span class="c1">#   self.calendar</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="p">,</span> <span class="n">variableMap</span><span class="p">)</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>

        <span class="c1"># then, perform additional checks specific to this analysis</span>
        <span class="n">possibleArgs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blah&#39;</span><span class="p">,</span> <span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="s1">&#39;stuff&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">myArg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possibleArgs</span><span class="p">:</span>
            <span class="c1"># Note: we&#39;re going to allow a long line in this case because it</span>
            <span class="c1"># would be confusing to break up the string (even though it</span>
            <span class="c1"># violates the PEP8 standard)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;MyTask must be constructed with argument myArg having one of the values</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">possibleArgs</span><span class="p">))</span>

        <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;MyTask&#39;</span>
        <span class="n">startDate</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">-01-01_00:00:00&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;startYear&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;startDate&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;startDate&#39;</span><span class="p">,</span> <span class="n">startDate</span><span class="p">)</span>
        <span class="n">endDate</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">-12-31_23:59:59&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;endYear&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;endDate&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;endDate&#39;</span><span class="p">,</span> <span class="n">endDate</span><span class="p">)</span>

        <span class="c1"># }}}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the analysis task.</span>

<span class="sd">        Individual tasks (children classes of this base class) should first</span>
<span class="sd">        call this method to perform any common steps in an analysis task,</span>
<span class="sd">        then, perform the steps required to run the analysis task.</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        &lt;List of authors&gt;</span>

<span class="sd">        Last Modified</span>
<span class="sd">        -------------</span>
<span class="sd">        &lt;MM/DD/YYYY&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># here is where the main &quot;meat&quot; of the analysis task goes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_my_sub_task</span><span class="p">(</span><span class="s1">&#39;someText&#39;</span><span class="p">,</span> <span class="n">arg2</span><span class="o">=</span><span class="s1">&#39;differentText&#39;</span><span class="p">)</span>
        <span class="k">return</span>
        <span class="c1"># }}}</span>

    <span class="c1"># here is where you add helper methods that are meant to be non-public</span>
    <span class="c1"># (they start with an underscore), meaning you don&#39;t expect anyone to</span>
    <span class="c1"># access them outside of this file.  Typically you won&#39;t put as much in</span>
    <span class="c1"># the docstring as you would for a public function or method.</span>
    <span class="c1">#</span>
    <span class="c1"># you can either pass arguments (with or without defaults) or you can</span>
    <span class="c1"># &quot;save&quot; arguments as member variables of `self` and then get them back</span>
    <span class="c1"># (like `self.myArg` here).</span>
    <span class="k">def</span> <span class="nf">_my_sub_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &lt;Performs my favority subtask&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># perform the task</span>
        <span class="nb">print</span> <span class="s1">&#39;myArg:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">myArg</span>
        <span class="nb">print</span> <span class="s1">&#39;arg1:&#39;</span><span class="p">,</span> <span class="n">arg1</span>
        <span class="k">if</span> <span class="n">arg2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;arg2:&#39;</span><span class="p">,</span> <span class="n">arg2</span>
        <span class="c1"># }}}</span>

<span class="c1"># }}}</span>

<span class="c1"># vim: foldmethod=marker ai ts=4 sts=4 et sw=4 ft=python</span>
</pre></div>
</div>
<h4> Implementation: Validation within Analysis Tasks <br>
Date last modified: 2017/03/08 <br>
Contributors: Xylar Asay-Davis
</h4><p>Here is an example (from <code class="docutils literal notranslate"><span class="pre">ocean.climatology_map.ClimatologyMap</span></code>) of what
the new <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> methods :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variableMap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">fieldName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the analysis task.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config :  instance of MpasAnalysisConfigParser</span>
<span class="sd">        Contains configuration options</span>

<span class="sd">    streamMap : dict, optional</span>
<span class="sd">        A dictionary of MPAS-O stream names that map to their mpas_analysis</span>
<span class="sd">        counterparts.</span>

<span class="sd">    variableMap : dict, optional</span>
<span class="sd">        A dictionary of MPAS-O variable names that map to their</span>
<span class="sd">        mpas_analysis counterparts.</span>

<span class="sd">    fieldName : {&#39;sst&#39;, &#39;mld&#39;, &#39;sss&#39;}</span>
<span class="sd">        The name of the field to be analyzed</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError : if `fieldName` is not provided or is not one of the</span>
<span class="sd">        supported values</span>

<span class="sd">    Authors</span>
<span class="sd">    -------</span>
<span class="sd">    Xylar Asay-Davis</span>

<span class="sd">    Last Modified</span>
<span class="sd">    -------------</span>
<span class="sd">    03/16/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># first, call the constructor from the base class (AnalysisTask)</span>
    <span class="n">AnalysisTask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="p">,</span> <span class="n">variableMap</span><span class="p">)</span>

    <span class="n">upperFieldNames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="s1">&#39;SST&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;mld&#39;</span><span class="p">:</span> <span class="s1">&#39;MLD&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;sss&#39;</span><span class="p">:</span> <span class="s1">&#39;SSS&#39;</span>
                       <span class="c1"># &#39;nino34&#39;: &#39;Nino34&#39;,</span>
                       <span class="c1"># &#39;mht&#39;: &#39;MHT&#39;</span>
                       <span class="c1"># &#39;moc&#39;: &#39;MOC&#39;</span>
                       <span class="p">}</span>

    <span class="k">if</span> <span class="n">fieldName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;fieldName must be supplied.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fieldName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">upperFieldNames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;fieldName must be one of </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">upperFieldNames</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fieldName</span> <span class="o">=</span> <span class="n">fieldName</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">upperFieldName</span> <span class="o">=</span> <span class="n">upperFieldNames</span><span class="p">[</span><span class="n">fieldName</span><span class="p">]</span>

    <span class="c1"># name the task, component and category</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">taskName</span> <span class="o">=</span> <span class="s1">&#39;climatologyMap</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upperFieldName</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">componentName</span> <span class="o">=</span> <span class="s1">&#39;ocean&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;climatologyMap&#39;</span><span class="p">,</span> <span class="n">fieldName</span><span class="p">]</span>

    <span class="c1"># }}}</span>

<span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># {{{</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform steps to set up the analysis and check for errors in the setup.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    OSError</span>
<span class="sd">        If files are not present</span>

<span class="sd">    Authors</span>
<span class="sd">    -------</span>
<span class="sd">    Xylar Asay-Davis</span>

<span class="sd">    Last Modified</span>
<span class="sd">    -------------</span>
<span class="sd">    03/16/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;climatology&#39;</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">-01-01_00:00:00&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;startYear&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;startDate&#39;</span><span class="p">):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;startDate&#39;</span><span class="p">,</span> <span class="n">startDate</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">-12-31_23:59:59&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;endYear&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;endDate&#39;</span><span class="p">):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;endDate&#39;</span><span class="p">,</span> <span class="n">endDate</span><span class="p">)</span>

    <span class="k">return</span>  <span class="c1"># }}}</span>
</pre></div>
</div>
<p>Much of this code has been taken out of <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code>, simplifying and clarifying
the code.</p>
<h4> Implementation: Analysis Continues even when Analysis Task Fails <br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>Calls to <code class="docutils literal notranslate"><span class="pre">check</span></code> and <code class="docutils literal notranslate"><span class="pre">run</span></code> methods in <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code> are inside of
<code class="docutils literal notranslate"><span class="pre">try/except</span></code> blocks, which catch the exceptions and print the stack trace
but don’t cause the code to exit.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">analysisTask</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
<span class="o">...</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;ERROR: analysis module </span><span class="si">{}</span><span class="s2"> failed during check and &quot;</span> \
        <span class="s2">&quot;will not be run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysisTask</span><span class="o">.</span><span class="n">taskName</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">analysisModule</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;ERROR: analysis module </span><span class="si">{}</span><span class="s2"> failed during run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">analysisTask</span><span class="o">.</span><span class="n">taskName</span><span class="p">)</span>
</pre></div>
</div>
<h4> Implementation: List of Tasks to Perform<br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>The tasks are imported and added to an anaysis list as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">analyses</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Ocean Analyses</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.ocean.time_series_ohc</span> <span class="kn">import</span> <span class="n">TimeSeriesOHC</span>
<span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TimeSeriesOHC</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="n">oceanStreamMap</span><span class="p">,</span>
                              <span class="n">variableMap</span><span class="o">=</span><span class="n">oceanVariableMap</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.ocean.time_series_sst</span> <span class="kn">import</span> <span class="n">TimeSeriesSST</span>
<span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TimeSeriesSST</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="n">oceanStreamMap</span><span class="p">,</span>
                              <span class="n">variableMap</span><span class="o">=</span><span class="n">oceanVariableMap</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.ocean.climatology_map</span> <span class="kn">import</span> <span class="n">ClimatologyMap</span> \
    <span class="k">as</span> <span class="n">ClimatologyMapOcean</span>
<span class="k">for</span> <span class="n">fieldName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;mld&#39;</span><span class="p">,</span> <span class="s1">&#39;sss&#39;</span><span class="p">]:</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClimatologyMapOcean</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="n">oceanStreamMap</span><span class="p">,</span>
                                        <span class="n">variableMap</span><span class="o">=</span><span class="n">oceanVariableMap</span><span class="p">,</span>
                                        <span class="n">fieldName</span><span class="o">=</span><span class="n">fieldName</span><span class="p">))</span>

<span class="c1"># Sea Ice Analyses</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.sea_ice.timeseries</span> <span class="kn">import</span> <span class="n">TimeSeries</span> <span class="k">as</span> <span class="n">TimeSeriesSeaIce</span>
<span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TimeSeriesSeaIce</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="n">seaIceStreamMap</span><span class="p">,</span>
                                 <span class="n">variableMap</span><span class="o">=</span><span class="n">seaIceVariableMap</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.sea_ice.climatology_map</span> <span class="kn">import</span> <span class="n">ClimatologyMap</span> \
    <span class="k">as</span> <span class="n">ClimatologyMapSeaIce</span>
<span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClimatologyMapSeaIce</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">streamMap</span><span class="o">=</span><span class="n">seaIceStreamMap</span><span class="p">,</span>
                                     <span class="n">variableMap</span><span class="o">=</span><span class="n">seaIceVariableMap</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">analyses</span></code> list is a list of instances of subclasses of <code class="docutils literal notranslate"><span class="pre">AnalysisTask</span></code>.</p>
<p>Subsequent calls to analysis functions can loop over analyses, as in the following
example for calling <code class="docutils literal notranslate"><span class="pre">run</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># run each analysis task</span>
<span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">analysisTask</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s2">&quot;ERROR: analysis module </span><span class="si">{}</span><span class="s2"> failed during run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">taskName</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="raw-html-m2r"><h3> Testing </h3></span></p>
<h4> Testing and Validation: Template for Analysis Tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>Ideally, the test here would be having another developer create an analysis task based on this
template.  Realistically, this won’t happen before the template gets merged into the repository,
so I’m counting on feedback from other developers to “test” the template before it gets merged,
and there will probably need to be subsequent PRs to make changes as issues arise.</p>
<h4> Testing and Validation: Validation within Analysis Tasks <br>
Date last modified: 2017/03/16 <br>
Contributors: Xylar Asay-Davis
</h4><p>I have added <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> functions within each analysis task.  So far, these check for only a subset of
the necessary configuration and input files, and could (and should) be expanded in the future.</p>
<p>I have verified that all <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> routines fail when the path to their respective observations and/or
preprocessed reference run is not found.</p>
<h4> Testing and Validation: Analysis Continues even when Analysis Task Fails <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>I have verified using the <code class="docutils literal notranslate"><span class="pre">GMPAS_QU240</span></code> test case and by deliberately introducing errors in the file
paths that an error in a given analysis task (either during <code class="docutils literal notranslate"><span class="pre">setup_and_check</span></code> or <code class="docutils literal notranslate"><span class="pre">run</span></code>) causes that task to
print a stack trace and an error message but does not prevent other tasks from running.</p>
<h4> Testing and Validation: List of Tasks to Perform<br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>As stated in implementation, there is a single place in <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code> where a developer would add
her or his task to the analysis.  I think this requirement has been satisfied without requiring testing.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="remapper.html" class="btn btn-neutral float-left" title="Remapper for “online” remapping of data sets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="prerequisite_tasks.html" class="btn btn-neutral float-right" title="Prerequisite Tasks and Subtasks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright This software is open source software available under the BSD-3license. Copyright (c) 2022 Triad National Security, LLC. All rights reserved. Copyright (c) 2018 Lawrence Livermore National Security, LLC. All rights reserved. Copyright (c) 2018 UT-Battelle, LLC. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>