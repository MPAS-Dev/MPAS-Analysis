<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dask threads and subprocess count &mdash; MPAS-Analysis 1.9.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/documentation_options.js?v=60b3a732"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Diagnostics" href="diagnostics.html" />
    <link rel="prev" title="Execute" href="execute.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MPAS-Analysis
          </a>
              <div class="version">
                1.9.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../configuration.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="runs.html">Runs</a></li>
<li class="toctree-l2"><a class="reference internal" href="execute.html">Execute</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dask threads and subprocess count</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Dask threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subprocess-count">Subprocess count</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html">Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="input.html">Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="output.html">Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="climatology.html">Climatology</a></li>
<li class="toctree-l2"><a class="reference internal" href="timeSeries.html">Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html">Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="regions.html">Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot.html">Plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="html.html">HTML</a></li>
<li class="toctree-l2"><a class="reference internal" href="observations.html">Ocean, Sea Ice and Iceberg Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="preprocessed.html">Preprocessed Reference Runs</a></li>
<li class="toctree-l2"><a class="reference internal" href="colormaps.html">Colormaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="seasons.html">Seasons</a></li>
<li class="toctree-l2"><a class="reference internal" href="comparison_grids.html">Comparison Grids</a></li>
<li class="toctree-l2"><a class="reference internal" href="moving_average.html">Moving Average</a></li>
<li class="toctree-l2"><a class="reference internal" href="time_axis_ticks.html">Time-Axis Tick Marks</a></li>
<li class="toctree-l2"><a class="reference internal" href="transects.html">Output Grids for Transects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../analysis_tasks.html">Analysis Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components.html">MPAS Components and E3SM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observations.html">Observations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developers_guide/api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design_docs/index.html">Design Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/getting_started.html">User: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/dev_getting_started.html">Developer: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/dev_understand_a_task.html">Developers: Understanding an analysis task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/dev_add_task.html">Developers: Adding a new analysis task</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Authors</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Main Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html#contributors">Contributors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../versions.html">Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MPAS-Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../configuration.html">Configuration</a></li>
      <li class="breadcrumb-item active">Dask threads and subprocess count</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/users_guide/config/dask_threads.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dask-threads-and-subprocess-count">
<span id="dask-threads"></span><h1>Dask threads and subprocess count<a class="headerlink" href="#dask-threads-and-subprocess-count" title="Link to this heading">¶</a></h1>
<p>Several tasks and subtasks have config options <code class="docutils literal notranslate"><span class="pre">daskThreads</span></code> and
<code class="docutils literal notranslate"><span class="pre">subprocessCount</span></code> used to control threading within a subtask:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># The number of threads dask is allowed to spawn for each task/subtask.</span>
<span class="c1"># Decrease this number if tasks/subtasks are running out of available threads</span>
<span class="n">daskThreads</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># The number of subprocesses that each task/subtask gets counted as</span>
<span class="c1"># occupying. Increase this number if tasks/subtasks are running out of</span>
<span class="c1"># memory, so that fewer tasks will be allowed to run at once</span>
<span class="n">subprocessCount</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<section id="id1">
<h2>Dask threads<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p>Dask and xarray support thread-parallel operations on data sets.  They also
support chunk-wise operation on data sets that can’t fit in memory.  These
capabilities are very powerful but also difficult to configure for general
cases.  Dask is also not desigend by default with the idea that multiple tasks,
each with multiple dask threads, might operate simultaneously.  As a result,
it is possible to spawn huge numbers of dask threads in MPAS-Analysis that both
slow down analysis and lead to errors when the node runs out of threads
completely.</p>
<p>To prevent this, many tasks or subtasks that use dask threading take the number
of execution threads from a config option, typically in the config section for
the parent task.  Typically, the number of <code class="docutils literal notranslate"><span class="pre">daskThreads</span></code> should be around
the same as the number of cores on a node divided by the number of tasks
that will run simultaneiously.  Since the number of running tasks is controlled
by <code class="docutils literal notranslate"><span class="pre">subprocessCount</span></code>, see below, this number might differ from
<code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code>.</p>
</section>
<section id="subprocess-count">
<h2>Subprocess count<a class="headerlink" href="#subprocess-count" title="Link to this heading">¶</a></h2>
<p>Tasks or subtasks that use dask threading may consume too much memory or use
too many threads to “count” as a single task.  That is, it might not be safe to
run with <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code> simultaneious instances of the task/subtask and
it would be better if it occupied the slot of multiple tasks in the pool of
tasks.  MPAS-Analysis will treat a dask-based task or subtask as occupying
the number of task slots given by the <code class="docutils literal notranslate"><span class="pre">subprocessCount</span></code> option.  For example,
if <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span> <span class="pre">=</span> <span class="pre">8</span></code> and <code class="docutils literal notranslate"><span class="pre">subprocessCount</span> <span class="pre">=</span> <span class="pre">2</span></code>, up to 4 tasks or
subtasks would be allowed to run simultaneiously.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="execute.html" class="btn btn-neutral float-left" title="Execute" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="diagnostics.html" class="btn btn-neutral float-right" title="Diagnostics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright This software is open source software available under the BSD-3license. Copyright (c) 2022 Triad National Security, LLC. All rights reserved. Copyright (c) 2018 Lawrence Livermore National Security, LLC. All rights reserved. Copyright (c) 2018 UT-Battelle, LLC. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>