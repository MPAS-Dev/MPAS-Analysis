

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>mpas_analysis.__main__ &mdash; MPAS-Analysis 1.4.0rc3 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MPAS-Analysis
          

          
          </a>

          
            
            
              <div class="version">
                1.4.0rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis_tasks.html">Analysis Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components.html">MPAS Components and E3SM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observations.html">Observations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design_docs.html">Design Documents</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Main Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html#contributors">Contributors</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../versions.html">Versions</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MPAS-Analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>mpas_analysis.__main__</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mpas_analysis.__main__</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># This software is open source software available under the BSD-3 license.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2020 Triad National Security, LLC. All rights reserved.</span>
<span class="c1"># Copyright (c) 2020 Lawrence Livermore National Security, LLC. All rights</span>
<span class="c1"># reserved.</span>
<span class="c1"># Copyright (c) 2020 UT-Battelle, LLC. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Additional copyright and license information can be found in the LICENSE file</span>
<span class="c1"># distributed with this code, or at</span>
<span class="c1"># https://raw.githubusercontent.com/MPAS-Dev/MPAS-Analysis/master/LICENSE</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Runs MPAS-Analysis via a configuration file (e.g. `config.analysis`)</span>
<span class="sd">specifying analysis options.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Authors</span>
<span class="c1"># -------</span>
<span class="c1"># Xylar Asay-Davis, Phillip J. Wolfram, Milena Veneziani</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> \
    <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">mpas_analysis</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">progressbar</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">xarray</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared.analysis_task</span> <span class="kn">import</span> <span class="n">AnalysisFormatter</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.configuration</span> <span class="kn">import</span> <span class="n">MpasAnalysisConfigParser</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared.io.utility</span> <span class="kn">import</span> <span class="n">build_config_full_path</span><span class="p">,</span> \
    <span class="n">make_directories</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared.html</span> <span class="kn">import</span> <span class="n">generate_html</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared</span> <span class="kn">import</span> <span class="n">AnalysisTask</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.shared.analysis_task</span> <span class="kn">import</span> \
    <span class="n">update_time_bounds_from_file_names</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared.plot.colormap</span> <span class="kn">import</span> <span class="n">register_custom_colormaps</span><span class="p">,</span> \
    <span class="n">_plot_color_gradients</span>

<span class="kn">from</span> <span class="nn">mpas_analysis</span> <span class="kn">import</span> <span class="n">ocean</span>
<span class="kn">from</span> <span class="nn">mpas_analysis</span> <span class="kn">import</span> <span class="n">sea_ice</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.shared.climatology</span> <span class="kn">import</span> <span class="n">MpasClimatologyTask</span><span class="p">,</span> \
    <span class="n">RefYearMpasClimatologyTask</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.shared.time_series</span> <span class="kn">import</span> <span class="n">MpasTimeSeriesTask</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared.regions</span> <span class="kn">import</span> <span class="n">ComputeRegionMasks</span>


<span class="k">def</span> <span class="nf">update_time_bounds_in_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the start and end year (and associated full date) for</span>
<span class="sd">    climatologies, time series and climate indices based on the files that are</span>
<span class="sd">    actually available.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : ``MpasAnalysisConfigParser`` object</span>
<span class="sd">        contains config options</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># By updating the bounds for each component, we should end up with the</span>
    <span class="c1"># more constrained time bounds if any component has less output than others</span>
    <span class="k">for</span> <span class="n">componentName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;seaIce&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;climatology&#39;</span><span class="p">,</span> <span class="s1">&#39;timeSeries&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">]:</span>
            <span class="n">update_time_bounds_from_file_names</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">componentName</span><span class="p">)</span>
    <span class="c1"># }}}</span>


<div class="viewcode-block" id="build_analysis_list"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.build_analysis_list.html#mpas_analysis.__main__.build_analysis_list">[docs]</a><span class="k">def</span> <span class="nf">build_analysis_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a list of analysis tasks. New tasks should be added here, following</span>
<span class="sd">    the approach used for existing analysis tasks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : ``MpasAnalysisConfigParser`` object</span>
<span class="sd">        contains config options</span>

<span class="sd">    controlConfig : ``MpasAnalysisConfigParser`` object</span>
<span class="sd">        contains config options for a control run, or ``None`` if no config</span>
<span class="sd">        file for a control run was specified</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analyses : list of ``AnalysisTask`` objects</span>
<span class="sd">        A list of all analysis tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authors</span>
    <span class="c1"># -------</span>
    <span class="c1"># Xylar Asay-Davis</span>

    <span class="n">analyses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Ocean Analyses</span>
    <span class="n">oceanClimatolgyTasks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]:</span>
        <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">MpasClimatologyTask</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                                       <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
                                                       <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">)</span>
    <span class="n">oceanTimeSeriesTask</span> <span class="o">=</span> <span class="n">MpasTimeSeriesTask</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                             <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">)</span>
    <span class="n">oceanIndexTask</span> <span class="o">=</span> <span class="n">MpasTimeSeriesTask</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                        <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
                                        <span class="n">section</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

    <span class="n">oceanRefYearClimatolgyTask</span> <span class="o">=</span> <span class="n">RefYearMpasClimatologyTask</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">)</span>

    <span class="n">oceanRegionMasksTask</span> <span class="o">=</span> <span class="n">ComputeRegionMasks</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                              <span class="n">conponentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">oceanClimatolgyTasks</span><span class="p">:</span>
        <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="n">op</span><span class="p">])</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oceanRefYearClimatolgyTask</span><span class="p">)</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapMLD</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapMLDMinMax</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                                  <span class="n">oceanClimatolgyTasks</span><span class="p">,</span>
                                                  <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapSST</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapSSS</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapSSH</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapEKE</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapOHCAnomaly</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">oceanRefYearClimatolgyTask</span><span class="p">,</span>
        <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapSose</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapWoa</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapBGC</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapArgoTemperature</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapArgoSalinity</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapSchmidtko</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">ClimatologyMapAntarcticMelt</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">oceanRegionMasksTask</span><span class="p">,</span>
        <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">RegionalTSDiagrams</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">oceanRegionMasksTask</span><span class="p">,</span>
        <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesAntarcticMelt</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanTimeSeriesTask</span><span class="p">,</span>
                                                  <span class="n">oceanRegionMasksTask</span><span class="p">,</span>
                                                  <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesOceanRegions</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanRegionMasksTask</span><span class="p">,</span>
                                                 <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesTemperatureAnomaly</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                                       <span class="n">oceanTimeSeriesTask</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesSalinityAnomaly</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                                    <span class="n">oceanTimeSeriesTask</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesOHCAnomaly</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                               <span class="n">oceanTimeSeriesTask</span><span class="p">,</span>
                                               <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesSSHAnomaly</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                               <span class="n">oceanTimeSeriesTask</span><span class="p">,</span>
                                               <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesSST</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanTimeSeriesTask</span><span class="p">,</span>
                                        <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">TimeSeriesTransport</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">MeridionalHeatTransport</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span> <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">StreamfunctionMOC</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                            <span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">IndexNino34</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanIndexTask</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">WoceTransects</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                        <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">SoseTransects</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                        <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">GeojsonTransects</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">oceanClimatolgyTasks</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">],</span>
                                           <span class="n">controlConfig</span><span class="p">))</span>

    <span class="n">oceanRegionalProfiles</span> <span class="o">=</span> <span class="n">ocean</span><span class="o">.</span><span class="n">OceanRegionalProfiles</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanRegionMasksTask</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">)</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oceanRegionalProfiles</span><span class="p">)</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ocean</span><span class="o">.</span><span class="n">HovmollerOceanRegions</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">oceanRegionMasksTask</span><span class="p">,</span> <span class="n">oceanRegionalProfiles</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">))</span>

    <span class="c1"># Sea Ice Analyses</span>
    <span class="n">seaIceClimatolgyTask</span> <span class="o">=</span> <span class="n">MpasClimatologyTask</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                               <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;seaIce&#39;</span><span class="p">)</span>
    <span class="n">seaIceTimeSeriesTask</span> <span class="o">=</span> <span class="n">MpasTimeSeriesTask</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                              <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;seaIce&#39;</span><span class="p">)</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seaIceClimatolgyTask</span><span class="p">)</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sea_ice</span><span class="o">.</span><span class="n">ClimatologyMapSeaIceConc</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">mpasClimatologyTask</span><span class="o">=</span><span class="n">seaIceClimatolgyTask</span><span class="p">,</span>
        <span class="n">hemisphere</span><span class="o">=</span><span class="s1">&#39;NH&#39;</span><span class="p">,</span> <span class="n">controlConfig</span><span class="o">=</span><span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sea_ice</span><span class="o">.</span><span class="n">ClimatologyMapSeaIceThick</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">mpasClimatologyTask</span><span class="o">=</span><span class="n">seaIceClimatolgyTask</span><span class="p">,</span>
        <span class="n">hemisphere</span><span class="o">=</span><span class="s1">&#39;NH&#39;</span><span class="p">,</span> <span class="n">controlConfig</span><span class="o">=</span><span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sea_ice</span><span class="o">.</span><span class="n">ClimatologyMapSeaIceConc</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">mpasClimatologyTask</span><span class="o">=</span><span class="n">seaIceClimatolgyTask</span><span class="p">,</span>
        <span class="n">hemisphere</span><span class="o">=</span><span class="s1">&#39;SH&#39;</span><span class="p">,</span> <span class="n">controlConfig</span><span class="o">=</span><span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sea_ice</span><span class="o">.</span><span class="n">ClimatologyMapSeaIceThick</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">mpasClimatologyTask</span><span class="o">=</span><span class="n">seaIceClimatolgyTask</span><span class="p">,</span>
        <span class="n">hemisphere</span><span class="o">=</span><span class="s1">&#39;SH&#39;</span><span class="p">,</span> <span class="n">controlConfig</span><span class="o">=</span><span class="n">controlConfig</span><span class="p">))</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seaIceTimeSeriesTask</span><span class="p">)</span>

    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sea_ice</span><span class="o">.</span><span class="n">TimeSeriesSeaIce</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">seaIceTimeSeriesTask</span><span class="p">,</span>
                                             <span class="n">controlConfig</span><span class="p">))</span>

    <span class="c1"># Iceberg Analyses</span>
    <span class="n">analyses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sea_ice</span><span class="o">.</span><span class="n">ClimatologyMapIcebergConc</span><span class="p">(</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">mpasClimatologyTask</span><span class="o">=</span><span class="n">seaIceClimatolgyTask</span><span class="p">,</span>
        <span class="n">hemisphere</span><span class="o">=</span><span class="s1">&#39;SH&#39;</span><span class="p">,</span> <span class="n">controlConfig</span><span class="o">=</span><span class="n">controlConfig</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">analyses</span>  <span class="c1"># }}}</span></div>


<div class="viewcode-block" id="determine_analyses_to_generate"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.determine_analyses_to_generate.html#mpas_analysis.__main__.determine_analyses_to_generate">[docs]</a><span class="k">def</span> <span class="nf">determine_analyses_to_generate</span><span class="p">(</span><span class="n">analyses</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a list of analysis tasks to run based on the &#39;generate&#39; config</span>
<span class="sd">    option (or command-line flag) and prerequisites and subtasks of each</span>
<span class="sd">    requested task.  Each task&#39;s ``setup_and_check`` method is called in the</span>
<span class="sd">    process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analyses : list of ``AnalysisTask`` objects</span>
<span class="sd">        A list of all analysis tasks</span>

<span class="sd">    verbose : bool</span>
<span class="sd">        Whether to write out a full stack trace when exceptions occur during</span>
<span class="sd">        ``setup_and_check()`` calls for each task</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysesToGenerate : ``OrderedDict`` of ``AnalysisTask`` objects</span>
<span class="sd">        A dictionary of analysis tasks to run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authors</span>
    <span class="c1"># -------</span>
    <span class="c1"># Xylar Asay-Davis</span>

    <span class="n">totalFailures</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">analysesToGenerate</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="c1"># check which analysis we actually want to generate and only keep those</span>
    <span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="p">:</span>
        <span class="c1"># update the dictionary with this task and perhaps its subtasks</span>
        <span class="n">failureCount</span> <span class="o">=</span> <span class="n">add_task_and_subtasks</span><span class="p">(</span><span class="n">analysisTask</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="p">)</span>

        <span class="n">totalFailures</span> <span class="o">+=</span> <span class="n">failureCount</span>

    <span class="k">if</span> <span class="n">totalFailures</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> tasks and subtasks failed during setup.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">totalFailures</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;To find out why these tasks are failing, use the --verbose &#39;</span>
                  <span class="s1">&#39;flag&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">analysesToGenerate</span>  <span class="c1"># }}}</span></div>


<div class="viewcode-block" id="add_task_and_subtasks"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.add_task_and_subtasks.html#mpas_analysis.__main__.add_task_and_subtasks">[docs]</a><span class="k">def</span> <span class="nf">add_task_and_subtasks</span><span class="p">(</span><span class="n">analysisTask</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span>
                          <span class="n">callCheckGenerate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If a task has been requested through the generate config option or</span>
<span class="sd">    if it is a prerequisite of a requested task, add it to the dictionary of</span>
<span class="sd">    tasks to generate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    analysisTask : ``AnalysisTask``</span>
<span class="sd">        A task to be added</span>

<span class="sd">    analysesToGenerate : ``OrderedDict`` of ``AnalysisTask``</span>
<span class="sd">        The list of analysis tasks to be generated, which this call may</span>
<span class="sd">        update to include this task and its subtasks</span>

<span class="sd">    verbose : bool</span>
<span class="sd">        Whether to write out a full stack trace when exceptions occur during</span>
<span class="sd">        ``setup_and_check()`` calls for each task</span>

<span class="sd">    callCheckGenerate : bool</span>
<span class="sd">        Whether the ``check_generate`` method should be call for this task to</span>
<span class="sd">        see if it has been requested.  We skip this for subtasks and</span>
<span class="sd">        prerequisites, since they are needed by another task regardless of</span>
<span class="sd">        whether the user specifically requested them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authors</span>
    <span class="c1"># -------</span>
    <span class="c1"># Xylar Asay-Davis</span>

    <span class="n">totalFailures</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">analysisTask</span><span class="o">.</span><span class="n">taskName</span><span class="p">,</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtaskName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">analysesToGenerate</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># The task was already added</span>
        <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;task </span><span class="si">{}</span><span class="s2"> already added but this version was not set up &quot;</span>
                       <span class="s2">&quot;successfully. Typically, this indicates two tasks &quot;</span>
                       <span class="s2">&quot;with the same full name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="n">analysisTask</span><span class="o">.</span><span class="n">fullTaskName</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">totalFailures</span>

    <span class="c1"># for each anlaysis task, check if we want to generate this task</span>
    <span class="c1"># and if the analysis task has a valid configuration</span>
    <span class="n">taskTitle</span> <span class="o">=</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">printTaskName</span>
    <span class="k">if</span> <span class="n">callCheckGenerate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">check_generate</span><span class="p">():</span>
        <span class="c1"># we don&#39;t need to add this task -- it wasn&#39;t requested</span>
        <span class="k">return</span> <span class="n">totalFailures</span>

    <span class="c1"># first, we should try to add the prerequisites of this task and its</span>
    <span class="c1"># subtasks (if they aren&#39;t also subtasks for this task)</span>
    <span class="n">prereqs</span> <span class="o">=</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">runAfterTasks</span>
    <span class="k">for</span> <span class="n">subtask</span> <span class="ow">in</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">prereq</span> <span class="ow">in</span> <span class="n">subtask</span><span class="o">.</span><span class="n">runAfterTasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prereq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
                <span class="n">prereqs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subtask</span><span class="o">.</span><span class="n">runAfterTasks</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">prereq</span> <span class="ow">in</span> <span class="n">prereqs</span><span class="p">:</span>
        <span class="n">failureCount</span> <span class="o">=</span> <span class="n">add_task_and_subtasks</span><span class="p">(</span><span class="n">prereq</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="p">,</span> <span class="n">callCheckGenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">totalFailures</span> <span class="o">+=</span> <span class="n">failureCount</span>
        <span class="k">if</span> <span class="n">prereq</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">failureCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># a prereq failed setup_and_check</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: prerequisite of </span><span class="si">{}</span><span class="s2"> failed during check, &quot;</span>
                  <span class="s2">&quot;so this task will not be run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="n">taskTitle</span><span class="p">))</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
            <span class="n">totalFailures</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">totalFailures</span>

    <span class="c1"># make sure all prereqs have been set up successfully before trying to</span>
    <span class="c1"># set up this task -- this task&#39;s setup may depend on setup in the prereqs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">analysisTask</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="si">{}</span><span class="s2"> failed during check and will not be run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">taskTitle</span><span class="p">))</span>
        <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
        <span class="n">totalFailures</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">totalFailures</span>

    <span class="c1"># next, we should try to add the subtasks.  This is done after the current</span>
    <span class="c1"># analysis task has been set up in case subtasks depend on information</span>
    <span class="c1"># from the parent task</span>
    <span class="k">for</span> <span class="n">subtask</span> <span class="ow">in</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
        <span class="n">failureCount</span> <span class="o">=</span> <span class="n">add_task_and_subtasks</span><span class="p">(</span><span class="n">subtask</span><span class="p">,</span> <span class="n">analysesToGenerate</span><span class="p">,</span>
                                             <span class="n">verbose</span><span class="p">,</span> <span class="n">callCheckGenerate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">totalFailures</span> <span class="o">+=</span> <span class="n">failureCount</span>
        <span class="k">if</span> <span class="n">subtask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">failureCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># a subtask failed setup_and_check</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: subtask of </span><span class="si">{}</span><span class="s2"> failed during check, &quot;</span>
                  <span class="s2">&quot;so this task will not be run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="n">taskTitle</span><span class="p">))</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
            <span class="n">totalFailures</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">totalFailures</span>

    <span class="n">analysesToGenerate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysisTask</span>
    <span class="n">analysisTask</span><span class="o">.</span><span class="n">_setupStatus</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">totalFailures</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">totalFailures</span></div>
    <span class="c1"># }}}</span>


<div class="viewcode-block" id="update_generate"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.update_generate.html#mpas_analysis.__main__.update_generate">[docs]</a><span class="k">def</span> <span class="nf">update_generate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">generate</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the &#39;generate&#39; config option using a string from the command line.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : ``MpasAnalysisConfigParser`` object</span>
<span class="sd">        contains config options</span>

<span class="sd">    generate : str</span>
<span class="sd">        a comma-separated string of generate flags: either names of analysis</span>
<span class="sd">        tasks or commands of the form ``all_&lt;tag&gt;`` or ``no_&lt;tag&gt;`` indicating</span>
<span class="sd">        that analysis with a given tag should be included or excluded).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authors</span>
    <span class="c1"># -------</span>
    <span class="c1"># Xylar Asay-Davis</span>

    <span class="c1"># overwrite the &#39;generate&#39; in config with a string that parses to</span>
    <span class="c1"># a list of string</span>
    <span class="n">generateList</span> <span class="o">=</span> <span class="n">generate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">generateString</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">generateList</span><span class="p">])</span>
    <span class="n">generateString</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">generateString</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;generate&#39;</span><span class="p">,</span> <span class="n">generateString</span><span class="p">)</span>  <span class="c1"># }}}</span></div>


<div class="viewcode-block" id="run_analysis"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.run_analysis.html#mpas_analysis.__main__.run_analysis">[docs]</a><span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">analyses</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run all the tasks, either in serial or in parallel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : ``MpasAnalysisConfigParser`` object</span>
<span class="sd">        contains config options</span>

<span class="sd">    analyses : OrderedDict of ``AnalysisTask`` objects</span>
<span class="sd">        A dictionary of analysis tasks to run with (task, subtask) names as</span>
<span class="sd">        keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authors</span>
    <span class="c1"># -------</span>
    <span class="c1"># Xylar Asay-Davis</span>

    <span class="c1"># write the config file the log directory</span>
    <span class="n">logsDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;logsSubdirectory&#39;</span><span class="p">)</span>

    <span class="n">mainRunName</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;mainRunName&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mainRunName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">55</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: The main run name is quite long and will be &#39;</span>
              <span class="s1">&#39;truncated in some plots: </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainRunName</span><span class="p">))</span>

    <span class="n">configFileName</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/config.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">,</span> <span class="n">mainRunName</span><span class="p">)</span>

    <span class="n">configFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">configFileName</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>
    <span class="n">configFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">parallelTaskCount</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getWithDefault</span><span class="p">(</span><span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="s1">&#39;parallelTaskCount&#39;</span><span class="p">,</span>
                                              <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">isParallel</span> <span class="o">=</span> <span class="n">parallelTaskCount</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">analyses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">runAfterTasks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span><span class="p">:</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">READY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">BLOCKED</span>

    <span class="n">tasksWithErrors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">runningTasks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># redirect output to a log file</span>
    <span class="n">logsDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;logsSubdirectory&#39;</span><span class="p">)</span>

    <span class="n">logFileName</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/taskProgress.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">)</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;mpas_analysis&#39;</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logFileName</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">AnalysisFormatter</span><span class="p">()</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">totalTaskCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">analyses</span><span class="p">)</span>
    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Running tasks: &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
               <span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ETA</span><span class="p">()]</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">,</span>
                                       <span class="n">max_value</span><span class="o">=</span><span class="n">totalTaskCount</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">runningProcessCount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># run each analysis task</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># we still have tasks to run</span>
        <span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">BLOCKED</span><span class="p">:</span>
                <span class="n">prereqs</span> <span class="o">=</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">runAfterTasks</span> <span class="o">+</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtasks</span>
                <span class="n">prereqStatus</span> <span class="o">=</span> <span class="p">[</span><span class="n">prereq</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">prereq</span> <span class="ow">in</span> <span class="n">prereqs</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">runStatus</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">FAIL</span> <span class="k">for</span> <span class="n">runStatus</span> <span class="ow">in</span>
                        <span class="n">prereqStatus</span><span class="p">]):</span>
                    <span class="c1"># a prerequisite failed so this task cannot succeed</span>
                    <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">FAIL</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">runStatus</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">SUCCESS</span> <span class="k">for</span> <span class="n">runStatus</span> <span class="ow">in</span>
                        <span class="n">prereqStatus</span><span class="p">]):</span>
                    <span class="c1"># no unfinished prerequisites so we can run this task</span>
                    <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">READY</span>

        <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">AnalysisTask</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
                                                     <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">FAIL</span><span class="p">]:</span>
                <span class="n">unfinishedCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">totalTaskCount</span> <span class="o">-</span> <span class="n">unfinishedCount</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unfinishedCount</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">runningProcessCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># we&#39;re done</span>
            <span class="k">break</span>

        <span class="c1"># launch new tasks</span>
        <span class="n">runDirectly</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">READY</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">isParallel</span><span class="p">:</span>
                    <span class="n">newProcessCount</span> <span class="o">=</span> <span class="n">runningProcessCount</span> <span class="o">+</span> \
                        <span class="n">analysisTask</span><span class="o">.</span><span class="n">subprocessCount</span>
                    <span class="k">if</span> <span class="n">newProcessCount</span> <span class="o">&gt;</span> <span class="n">parallelTaskCount</span> <span class="ow">and</span> \
                            <span class="n">runningProcessCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># this task should run next but we need to wait for</span>
                        <span class="c1"># more processes to finish</span>
                        <span class="k">break</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">analysisTask</span><span class="o">.</span><span class="n">printTaskName</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">runDirectly</span><span class="p">:</span>
                        <span class="n">analysisTask</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">writeLogFile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">runDirectly</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">RUNNING</span>
                        <span class="n">analysisTask</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="n">runningTasks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysisTask</span>
                        <span class="n">runningProcessCount</span> <span class="o">=</span> <span class="n">newProcessCount</span>
                        <span class="k">if</span> <span class="n">runningProcessCount</span> <span class="o">&gt;=</span> <span class="n">parallelTaskCount</span><span class="p">:</span>
                            <span class="c1"># don&#39;t try to run any more tasks</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">analysisTask</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">writeLogFile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">isParallel</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">runDirectly</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">runningProcessCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># wait for a task to finish</span>
                <span class="n">analysisTask</span> <span class="o">=</span> <span class="n">wait_for_task</span><span class="p">(</span><span class="n">runningTasks</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">analysisTask</span><span class="o">.</span><span class="n">taskName</span><span class="p">,</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subtaskName</span><span class="p">)</span>
                <span class="n">runningTasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">runningProcessCount</span> <span class="o">-=</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">subprocessCount</span>

            <span class="n">taskTitle</span> <span class="o">=</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">printTaskName</span>

            <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Task </span><span class="si">{}</span><span class="s2"> has finished successfully.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">taskTitle</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;ERROR in task </span><span class="si">{}</span><span class="s2">.  See log file </span><span class="si">{}</span><span class="s2"> for &quot;</span> \
                          <span class="s2">&quot;details&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taskTitle</span><span class="p">,</span>
                                           <span class="n">analysisTask</span><span class="o">.</span><span class="n">_logFileName</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">tasksWithErrors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taskTitle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Unexpected status from in task </span><span class="si">{}</span><span class="s2">.  This may be &quot;</span> \
                          <span class="s2">&quot;a bug.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taskTitle</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">_runStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">AnalysisTask</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">progress</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="c1"># blank line to make sure remaining output is on a new line</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># raise the last exception so the process exits with an error</span>
    <span class="n">errorCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasksWithErrors</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errorCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There were errors in task </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tasksWithErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">errorCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There were errors in </span><span class="si">{}</span><span class="s2"> tasks: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">errorCount</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tasksWithErrors</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;See log files in </span><span class="si">{}</span><span class="s2"> for details.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following commands may be helpful:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  cd </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  grep Error *.log&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Log files for executed tasks can be found in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">logsDirectory</span><span class="p">))</span></div>

    <span class="c1"># }}}</span>


<div class="viewcode-block" id="wait_for_task"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.wait_for_task.html#mpas_analysis.__main__.wait_for_task">[docs]</a><span class="k">def</span> <span class="nf">wait_for_task</span><span class="p">(</span><span class="n">runningTasks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a list of analysis modules based on the &#39;generate&#39; config option.</span>
<span class="sd">    New tasks should be added here, following the approach used for existing</span>
<span class="sd">    analysis tasks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    runningTasks : dict of ``AnalysisTasks``</span>
<span class="sd">        The tasks that are currently running, with task names as keys</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analysisTask : ``AnalysisTasks``</span>
<span class="sd">        A task that finished</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Authors</span>
    <span class="c1"># -------</span>
    <span class="c1"># Xylar Asay-Davis</span>

    <span class="c1"># necessary to have a timeout so we can kill the whole thing</span>
    <span class="c1"># with a keyboard interrupt</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">runningTasks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">analysisTask</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analysisTask</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">analysisTask</span>  <span class="c1"># }}}</span></div>


<span class="k">def</span> <span class="nf">purge_output</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">outputDirectory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;baseDirectory&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputDirectory</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output directory </span><span class="si">{}</span><span class="s1"> does not exist.</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;No purge necessary.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outputDirectory</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">subdirectory</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plots&#39;</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="s1">&#39;mpasClimatology&#39;</span><span class="p">,</span> <span class="s1">&#39;mapping&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;timeSeries&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;profiles&#39;</span><span class="p">]:</span>
            <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">Subdirectory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subdirectory</span><span class="p">)</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                <span class="n">relativePathOption</span><span class="o">=</span><span class="n">option</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting contents of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;seaIce&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">subdirectory</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;climatology&#39;</span><span class="p">,</span> <span class="s1">&#39;remappedClim&#39;</span><span class="p">]:</span>
                <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">Subdirectory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subdirectory</span><span class="p">)</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">Observations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                    <span class="n">relativePathOption</span><span class="o">=</span><span class="n">option</span><span class="p">,</span>
                    <span class="n">relativePathSection</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleting contents of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">symlink_main_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">defaultConfig</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create symlinks to the climatology and time-series directories for the</span>
<span class="sd">    main run that has aleady been computed so we don&#39;t have to recompute</span>
<span class="sd">    the analysis.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">link_dir</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="n">destDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                               <span class="n">relativePathOption</span><span class="o">=</span><span class="n">option</span><span class="p">,</span>
                                               <span class="n">relativePathSection</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destDirectory</span><span class="p">):</span>

            <span class="n">sourceDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="n">mainConfig</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                <span class="n">relativePathOption</span><span class="o">=</span><span class="n">option</span><span class="p">,</span> <span class="n">relativePathSection</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sourceDirectory</span><span class="p">):</span>

                <span class="n">destBase</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">destDirectory</span><span class="p">)</span>

                <span class="n">make_directories</span><span class="p">(</span><span class="n">destBase</span><span class="p">)</span>

                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">sourceDirectory</span><span class="p">,</span> <span class="n">destDirectory</span><span class="p">)</span>

    <span class="n">mainConfigFile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;mainRunConfigFile&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mainConfigFile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;A main config file </span><span class="si">{}</span><span class="s1"> was specified but the &#39;</span>
                      <span class="s1">&#39;file does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainConfigFile</span><span class="p">))</span>
    <span class="n">mainConfigFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mainConfigFile</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">defaultConfig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mainConfigFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaultConfig</span><span class="p">]</span> <span class="o">+</span> <span class="n">mainConfigFiles</span>
    <span class="n">mainConfig</span> <span class="o">=</span> <span class="n">MpasAnalysisConfigParser</span><span class="p">()</span>
    <span class="n">mainConfig</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">mainConfigFiles</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">subdirectory</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mpasClimatology&#39;</span><span class="p">,</span> <span class="s1">&#39;timeSeries&#39;</span><span class="p">,</span> <span class="s1">&#39;mapping&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;profiles&#39;</span><span class="p">]:</span>
        <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>
        <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">Subdirectory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subdirectory</span><span class="p">)</span>
        <span class="n">link_dir</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;seaIce&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">subdirectory</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;climatology&#39;</span><span class="p">,</span> <span class="s1">&#39;remappedClim&#39;</span><span class="p">]:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">Observations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
            <span class="n">option</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">Subdirectory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subdirectory</span><span class="p">)</span>
            <span class="n">link_dir</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">)</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../generated/mpas_analysis.__main__.main.html#mpas_analysis.__main__.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entry point for the main script ``mpas_analysis``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;mpas_analysis </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">mpas_analysis</span><span class="o">.</span><span class="n">__version__</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show version number and exit&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--setup_only&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;setup_only&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If only the setup phase, not the run or HTML &quot;</span>
                        <span class="s2">&quot;generation phases, should be executed.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--html_only&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;html_only&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If only the setup and HTML generation phases, &quot;</span>
                        <span class="s2">&quot;not the run phase, should be executed.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="s2">&quot;--generate&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;generate&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A list of analysis modules to generate &quot;</span>
                        <span class="s2">&quot;(nearly identical generate option in config file).&quot;</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;ANALYSIS1[,ANALYSIS2,ANALYSIS3,...]&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="s2">&quot;--list&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List the available analysis tasks&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--purge&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;purge&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Purge the analysis by deleting the output&quot;</span>
                        <span class="s2">&quot;directory before running&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;configFiles&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;CONFIG&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;config file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--plot_colormaps&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;plot_colormaps&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Make a plot displaying all available colormaps&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verbose error reporting during setup-and-check &quot;</span>
                             <span class="s2">&quot;phase&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">configFile</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">configFiles</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">configFile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Config file </span><span class="si">{}</span><span class="s1"> not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">configFile</span><span class="p">))</span>

    <span class="c1"># add config.default to cover default not included in the config files</span>
    <span class="c1"># provided on the command line</span>
    <span class="k">if</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_exists</span><span class="p">(</span><span class="s1">&#39;mpas_analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;config.default&#39;</span><span class="p">):</span>
        <span class="n">defaultConfig</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;mpas_analysis&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;config.default&#39;</span><span class="p">)</span>
        <span class="n">configFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaultConfig</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">configFiles</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Did not find config.default.  Assuming other config &#39;</span>
              <span class="s1">&#39;file(s) contain a</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;full set of configuration options.&#39;</span><span class="p">)</span>
        <span class="n">defaultConfig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">configFiles</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">configFiles</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">MpasAnalysisConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">configFiles</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
        <span class="n">analyses</span> <span class="o">=</span> <span class="n">build_analysis_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">controlConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">analysisTask</span> <span class="ow">in</span> <span class="n">analyses</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;task: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysisTask</span><span class="o">.</span><span class="n">taskName</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    component: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysisTask</span><span class="o">.</span><span class="n">componentName</span><span class="p">)),</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    tags: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">analysisTask</span><span class="o">.</span><span class="n">tags</span><span class="p">)))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot_colormaps</span><span class="p">:</span>
        <span class="n">register_custom_colormaps</span><span class="p">()</span>
        <span class="n">_plot_color_gradients</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;controlRunConfigFile&#39;</span><span class="p">):</span>
        <span class="n">controlConfigFile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;controlRunConfigFile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">controlConfigFile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;A control config file </span><span class="si">{}</span><span class="s1"> was specified but the &#39;</span>
                          <span class="s1">&#39;file does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">controlConfigFile</span><span class="p">))</span>
        <span class="n">controlConfigFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">controlConfigFile</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">defaultConfig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">controlConfigFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaultConfig</span><span class="p">]</span> <span class="o">+</span> <span class="n">controlConfigFiles</span>
        <span class="n">controlConfig</span> <span class="o">=</span> <span class="n">MpasAnalysisConfigParser</span><span class="p">()</span>
        <span class="n">controlConfig</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">controlConfigFiles</span><span class="p">)</span>

        <span class="c1"># replace the log directory so log files get written to this run&#39;s</span>
        <span class="c1"># log directory, not the control run&#39;s</span>
        <span class="n">logsDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;logsSubdirectory&#39;</span><span class="p">)</span>

        <span class="n">controlConfig</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;logsSubdirectory&#39;</span><span class="p">,</span> <span class="n">logsDirectory</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Comparing to control run </span><span class="si">{}</span><span class="s1"> rather than observations. </span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;Make sure that MPAS-Analysis has been run previously with the &#39;</span>
              <span class="s1">&#39;control config file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">controlConfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;mainRunName&#39;</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">controlConfig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">purge</span><span class="p">:</span>
        <span class="n">purge_output</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;mainRunConfigFile&#39;</span><span class="p">):</span>
        <span class="n">symlink_main_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">defaultConfig</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
        <span class="n">update_generate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">controlConfig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># we want to use the &quot;generate&quot; option from the current run, not</span>
        <span class="c1"># the control config file</span>
        <span class="n">controlConfig</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;generate&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;generate&#39;</span><span class="p">))</span>

    <span class="n">logsDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;logsSubdirectory&#39;</span><span class="p">)</span>
    <span class="n">make_directories</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">)</span>

    <span class="n">update_time_bounds_in_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">file_cache_maxsize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;file_cache_maxsize&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xarray</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">file_cache_maxsize</span><span class="o">=</span><span class="n">file_cache_maxsize</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># xarray version doesn&#39;t support file_cache_maxsize yet...</span>
        <span class="k">pass</span>

    <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">analyses</span> <span class="o">=</span> <span class="n">build_analysis_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">)</span>
    <span class="n">analyses</span> <span class="o">=</span> <span class="n">determine_analyses_to_generate</span><span class="p">(</span><span class="n">analyses</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">setupDuration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">setup_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">html_only</span><span class="p">:</span>
        <span class="n">run_analysis</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">analyses</span><span class="p">)</span>
        <span class="n">runDuration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">setupDuration</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total setup time: </span><span class="si">{}</span><span class="s1">:</span><span class="si">{:02d}</span><span class="s1">:</span><span class="si">{:05.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">runDuration</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total run time: </span><span class="si">{}</span><span class="s1">:</span><span class="si">{:02d}</span><span class="s1">:</span><span class="si">{:05.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">setup_only</span><span class="p">:</span>
        <span class="n">generate_html</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">analyses</span><span class="p">,</span> <span class="n">controlConfig</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">configFiles</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="c1"># vim: foldmethod=marker ai ts=4 sts=4 et sw=4 ft=python</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright This software is open source software available under the BSD-3license. Copyright (c) 2020 Triad National Security, LLC. All rights reserved. Copyright (c) 2018 Lawrence Livermore National Security, LLC. All rights reserved. Copyright (c) 2018 UT-Battelle, LLC. All rights reserved..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>