

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developers: Understanding an analysis task &mdash; MPAS-Analysis 1.12.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=fe8e256b"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Developers: Adding a new analysis task" href="dev_add_task.html" />
    <link rel="prev" title="Developer: Getting Started" href="dev_getting_started.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MPAS-Analysis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/analysis_tasks.html">Analysis Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/components.html">MPAS Components and E3SM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/observations.html">Observations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_docs/index.html">Design Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">User: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_getting_started.html">Developer: Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developers: Understanding an analysis task</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-big-picture">1. The big picture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mpas-output">1.1 MPAS output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#analysis-tasks">1.2 Analysis tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shared-framework">1.3 Shared framework</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tour-of-an-analysis-task-climatologymapohcanomaly">2. Tour of an analysis task (<code class="docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code>)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#attributes">2.1 Attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constructor">2.2 Constructor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-and-check-method">2.3 <code class="docutils literal notranslate"><span class="pre">setup_and_check()</span></code> method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tour-of-a-subtask-remapmpasohcclimatology">3. Tour of a subtask (<code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code>)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">3.1 Attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.2 Constructor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.3 <code class="docutils literal notranslate"><span class="pre">setup_and_check()</span></code> method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-task-method">3.4 <code class="docutils literal notranslate"><span class="pre">run_task()</span></code> method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customize-masked-climatology-method">3.5 <code class="docutils literal notranslate"><span class="pre">customize_masked_climatology()</span></code> method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-full-code-for-posterity">4. The full code for posterity</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dev_add_task.html">Developers: Adding a new analysis task</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Authors</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Main Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html#contributors">Contributors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MPAS-Analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Developers: Understanding an analysis task</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/dev_understand_a_task.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developers-understanding-an-analysis-task">
<span id="tutorial-understand-a-task"></span><h1>Developers: Understanding an analysis task<a class="headerlink" href="#developers-understanding-an-analysis-task" title="Link to this heading"></a></h1>
<p>This tutorial walks a new developer through an existing analysis task to get
a more in-depth understanding of the code.  This tutorial is meant as the
starting point for the <a class="reference internal" href="dev_add_task.html#tutorial-dev-add-task"><span class="std std-ref">Developers: Adding a new analysis task</span></a> tutorial.  It is a common
practice to find an existing analysis task that is as close as possible to the
new analysis, and to copy that existing task as a template for the new task.
This tutorial describes an existing analysis task, and
<a class="reference internal" href="dev_add_task.html#tutorial-dev-add-task"><span class="std std-ref">Developers: Adding a new analysis task</span></a> uses it as a starting point for developing a new
task.</p>
<section id="the-big-picture">
<h2>1. The big picture<a class="headerlink" href="#the-big-picture" title="Link to this heading"></a></h2>
<p>MPAS-Analysis is meant to provide a first look at E3SM simulation output from
the MPAS-Ocean and MPAS-Seaice components.  The analysis is intended to be
robust and automated.  However, there is currently little effort to ensure that
the time period covered by the observations and model output are the same.
In other words, we often compare pre-industrial simulation results with
present-day observations.  The justification for this is twofold.  First, we
typically have few if any observations covering the pre-industrial period.
Second, we may be attempting to reduce biases that we assess to be much larger
than expected differences between pre-industrial and present-day climate
conditions.  Under these conditions, MPAS-Analysis provides us with a useful
first impression of how our simulation is doing.</p>
<section id="mpas-output">
<h3>1.1 MPAS output<a class="headerlink" href="#mpas-output" title="Link to this heading"></a></h3>
<p>The primary output from MPAS-Ocean and MPAS-Seaice are monthly and daily
averages of a large number of data fields.  Here are links to the list of:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/E3SM-Project/E3SM/blob/main/components/mpas-ocean/cime_config/buildnml#L1082-L1290">MPAS-Ocean monthly fields</a></p></li>
<li><p><a class="reference external" href="https://github.com/E3SM-Project/E3SM/blob/main/components/mpas-ocean/cime_config/buildnml#L1028-L1062">MPAS-Ocean daily fields</a></p></li>
<li><p><a class="reference external" href="https://github.com/E3SM-Project/E3SM/blob/main/components/mpas-seaice/cime_config/buildnml#L726-L823">MPAS-Seaice monthly fields</a></p></li>
<li><p><a class="reference external" href="https://github.com/E3SM-Project/E3SM/blob/main/components/mpas-seaice/cime_config/buildnml#L695-L700">MPAS-Seaice daily fields</a></p></li>
</ul>
<p>The components also produce a smaller amount of more specialized output, such
as monthly maximum/minimum values.</p>
<p>MPAS data is provided on unstructured meshes, meaning that it isn’t
particularly amenable to analysis with standard tools such as
<a class="reference external" href="https://www.esmvaltool.org/">ESMValTool</a>.  Additionally, E3SM’s science
campaigns require unique, sometimes regionally focused analysis not available
in existing tools.</p>
</section>
<section id="analysis-tasks">
<h3>1.2 Analysis tasks<a class="headerlink" href="#analysis-tasks" title="Link to this heading"></a></h3>
<p>MPAS-Analysis is designed to a series of interdependent analysis tasks in
parallel with one another.  It builds up dependency graph between the tasks,
allowing independent tasks to run at the same time while putting dependent
tasks on hold until the tasks they depend on are completed.  Additionally,
MPAS-Analysis has some rudimentary tools for keeping track of the resources
that some computationally intensive tasks require to prevent the tool from
running out of memory.</p>
<p>Currently, nearly all operations in MPAS-Analysis must run on a single HPC
node.  (The exception is
<a class="reference external" href="http://nco.sourceforge.net/nco.html#ncclimo-netCDF-Climatology-Generator">ncclimo</a>,
which is used to generate climatologies, and which can run in parallel across
up to 12 nodes if desired.) We hope to support broader task parallelism in
the not-too-distant future using the <a class="reference external" href="https://parsl-project.org/">parsl</a>
python package.</p>
<p>Each analysis tasks is a class that descends from the
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a> base class.  Tasks
can also have “subtasks” that do part of the work needed for the final
analysis.  A subtask might perform a computation on a specific region, period
of time, or season.  It might combine data from other subtasks into a single
dataset.  Or it might plot the data computed by a previous task.  The
advantages of dividing up the work are 1) that each subtask can potentially
run in parallel with other subtasks and 2) it can allow code reuse if the same
subtask can be used across multiple analysis tasks.</p>
</section>
<section id="shared-framework">
<h3>1.3 Shared framework<a class="headerlink" href="#shared-framework" title="Link to this heading"></a></h3>
<p>MPAS-Analysis includes a shared framework used across analysis tasks.  The
framework is made up mostly of functions that can be called from within
analysis tasks but also includes some analysis tasks and subtasks that are
common to MPAS-Ocean, MPAS-Seaice and potentially other MPAS components
(notably MALI) that may be supported in the future.</p>
<p>This tutorial will not go though the shared framework in detail.  In addition
to the <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a> base class, the shared
framework includes the following
packages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls mpas_analysis/shared
climatology
constants
generalized_reader
html
interpolation
io
mpas_xarray
plot
projection
regions
time_series
timekeeping
transects
...
</pre></div>
</div>
<p>A separate tutorial will explore the shared framework and how how to modify it.</p>
</section>
</section>
<section id="tour-of-an-analysis-task-climatologymapohcanomaly">
<h2>2. Tour of an analysis task (<code class="docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code>)<a class="headerlink" href="#tour-of-an-analysis-task-climatologymapohcanomaly" title="Link to this heading"></a></h2>
<p>Aside from some code that takes care of managing analysis tasks and generating
web pages, MPAS-Analysis is made up almost entirely of analysis tasks and
shared functions they can call.  Since adding new analysis nearly always
mean creating a new class for the task, we start with a tour of an existing
analysis task as well as the <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a>
base class that it descends from.</p>
<p>We will use <a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a> as an
example analysis task for this tour because it will turn out to be a useful
staring point for the analysis we want to add in <a class="reference internal" href="dev_add_task.html#tutorial-dev-add-task"><span class="std std-ref">Developers: Adding a new analysis task</span></a>.
You can read more about <a class="reference internal" href="../users_guide/tasks/climatologyMapOHCAnomaly.html#task-climatologymapohcanomaly"><span class="std std-ref">climatologyMapOHCAnomaly</span></a> in the User’s
Guide.</p>
<p>It will be useful to open the following links in your browser to have a look
at the code directly:
<a class="reference external" href="https://github.com/MPAS-Dev/MPAS-Analysis/blob/main/mpas_analysis/ocean/climatology_map_ohc_anomaly.py">ClimatologyMapOHCAnomaly</a></p>
<p>If you want to be a little more adventurous, you can also pull up the code
for the base class:
<a class="reference external" href="https://github.com/MPAS-Dev/MPAS-Analysis/blob/develop/mpas_analysis/shared/analysis_task.py">AnalysisTask</a></p>
<section id="attributes">
<h3>2.1 Attributes<a class="headerlink" href="#attributes" title="Link to this heading"></a></h3>
<p>Classes can contain pieces of data called attributes.  In MPAS-Analysis, the
objects representing tasks share several attributes that they inherit from
the <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a> class.  A few of the most
important attributes of an analysis task are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">config</span></code> - an object for getting the values of config options</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">namelist</span></code> - an object for getting namelist options from the E3SM
simulation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runStreams</span></code> - an object for finding MPAS output files in the <code class="docutils literal notranslate"><span class="pre">run</span></code>
directory.  In practice, this is always a restart file used to get the
MPAS mesh and, for MPAS-Ocean, the vertical coordinate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">historyStreams</span></code> - an object for finding MPAS history streams (often
<code class="docutils literal notranslate"><span class="pre">timeSeriesStatsMonthlyOutput</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calendar</span></code> - the name of the calendar that was used in the MPAS run
(in practice always <code class="docutils literal notranslate"><span class="pre">'noleap'</span></code> or until recently <code class="docutils literal notranslate"><span class="pre">'gregorian_noleap'</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xmlFileNames</span></code> - a list of XML files associated with plots produced by this
analysis task.  As we will discuss, these are used to help populate the
web page showing the analysis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logger</span></code> - and object that keeps track of sending output to log files
(rather than the terminal) when the analysis is running.  During the
<code class="docutils literal notranslate"><span class="pre">run_task()</span></code> phase of the analysis when tasks are running in parallel with
each other, make sure to use <code class="docutils literal notranslate"><span class="pre">logger.info()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">print()</span></code> to
send output to the log file.</p></li>
</ul>
<p>Within the methods of analysis task class, these attributes can be accessed
using the <code class="docutils literal notranslate"><span class="pre">self</span></code> object, e.g. <code class="docutils literal notranslate"><span class="pre">self.config</span></code>.  It is often helpful to make
a local reference to the object to make the code more compact, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<span class="n">seasons</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="s1">&#39;climatologyMapOHCAnomaly&#39;</span><span class="p">,</span> <span class="s1">&#39;seasons&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The analysis task we’re looking at, <a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a>
has some attributes of its own:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mpasClimatologyTask</span></code> - the task that produced the climatology to be
remapped and plotted</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refYearClimatologyTask</span></code> - The task that produced the climatology from the
first year to be remapped and then subtracted from the main climatology
(since we want to plot an anomaly from the beginning of the simulation)</p></li>
</ul>
</section>
<section id="constructor">
<h3>2.2 Constructor<a class="headerlink" href="#constructor" title="Link to this heading"></a></h3>
<p>Almost all classes have “constructors”, which are methods for making a new
object of that class.  In python, the constructor is called <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>.
In general, the <code class="docutils literal notranslate"><span class="pre">__</span></code> (double underscore) is used in python to indicate a
function or method with special meaning.</p>
<p>The constructor of a subclass (such as
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a>) always calls the
constructor of the superclass (<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a>
in this case).  So we’ll talk about the constructor for
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a> first and then get
to <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a>.</p>
<p>The constructor for <a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a>
starts off like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">mpas_climatology_task</span><span class="p">,</span>
             <span class="n">ref_year_climatology_task</span><span class="p">,</span> <span class="n">control_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</pre></div>
</div>
<p>As with all methods, it takes the <code class="docutils literal notranslate"><span class="pre">self</span></code> object as the first argument.
Then, it takes a <code class="docutils literal notranslate"><span class="pre">config</span></code> object, which is true of all analysis tasks.  Then,
it has some other arguments that are more specific to the analysis being
performed.  Here, we have 2 other analysis tasks as arguments:
<code class="docutils literal notranslate"><span class="pre">mpasClimatologyTask</span></code> and <code class="docutils literal notranslate"><span class="pre">refYearClimatologyTask</span></code>.  As described in
the previous section, these are tasks for computing climatologies that will
later be remapped to a comparison grid for plotting.  A little later in the
constructor, we store references to these tasks as attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">mpas_climatology_task</span> <span class="o">=</span> <span class="n">mpas_climatology_task</span>
<span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span> <span class="o">=</span> <span class="n">ref_year_climatology_task</span>
</pre></div>
</div>
<p>Returning to the constructor above, the first thing we do it to call the
super class’s <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">mpas_climatology_task</span><span class="p">,</span>
             <span class="n">ref_year_climatology_task</span><span class="p">,</span> <span class="n">control_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the analysis task.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : mpas_tools.config.MpasConfigParser</span>
<span class="sd">        Configuration options</span>

<span class="sd">    mpas_climatology_task : mpas_analysis.shared.climatology.MpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology to be remapped and plotted</span>

<span class="sd">    ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology from the first year to be</span>
<span class="sd">        remapped and then subtracted from the main climatology</span>

<span class="sd">    control_config : mpas_tools.config.MpasConfigParser, optional</span>
<span class="sd">        Configuration options for a control run (if any)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">field_name</span> <span class="o">=</span> <span class="s1">&#39;deltaOHC&#39;</span>
    <span class="c1"># call the constructor from the base class (AnalysisTask)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">taskName</span><span class="o">=</span><span class="s1">&#39;climatologyMapOHCAnomaly&#39;</span><span class="p">,</span>
                     <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
                     <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;climatology&#39;</span><span class="p">,</span> <span class="s1">&#39;horizontalMap&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span>
                           <span class="s1">&#39;publicObs&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>We’re passing along the <code class="docutils literal notranslate"><span class="pre">config</span></code> options to the base class so it can store
them.  Then, we’re giving the task a unique <code class="docutils literal notranslate"><span class="pre">taskName</span></code> (the same as the class
name except that it starts with a lowercase letter).  We’re saying that the
MPAS <code class="docutils literal notranslate"><span class="pre">componentName</span></code> is the ocean.</p>
<p>Then, we giving the task a number of <code class="docutils literal notranslate"><span class="pre">tags</span></code> that can be helpful in
determining whether or not to generate this particular analysis based on the
<a class="reference internal" href="../users_guide/config/output.html#config-generate"><span class="std std-ref">Generate Option</span></a>.  The tags are used to describe various aspects of the
analysis.  Here, we will produce plots of a <code class="docutils literal notranslate"><span class="pre">climatology</span></code> (as opposed to a
time series). The plot will be a <code class="docutils literal notranslate"><span class="pre">horizontalMap</span></code>.  It will involve the
variable <code class="docutils literal notranslate"><span class="pre">deltaOHC</span></code>.  This analysis doesn’t involve any observations, but we
include a <code class="docutils literal notranslate"><span class="pre">publicObs</span></code> tag to indicate that it doesn’t require any proprietary
observational data sets that we do not have the rights to make public.
(Currently, we have a few such data sets for things like Antarctic melt rates.)
Finally, the analysis involves an <code class="docutils literal notranslate"><span class="pre">anomaly</span></code> computed relative to the
beginning of the simulation.</p>
<p>From there, we get the values of some config options, raising errors if we
find something unexpected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskName</span>

<span class="c1"># read in what seasons we want to plot</span>
<span class="n">seasons</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;seasons&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seasons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config section </span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s1"> does not contain &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;valid list of seasons&#39;</span><span class="p">)</span>

<span class="n">comparison_grid_names</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span>
                                             <span class="s1">&#39;comparisonGrids&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_grid_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config section </span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s1"> does not contain &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;valid list of comparison grids&#39;</span><span class="p">)</span>

<span class="n">depth_ranges</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="s1">&#39;climatologyMapOHCAnomaly&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;depthRanges&#39;</span><span class="p">,</span>
                                    <span class="n">use_numpyfunc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, these config options look like this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[climatologyMapOHCAnomaly]</span>
<span class="c1">## options related to plotting horizontally remapped climatologies of</span>
<span class="c1">## ocean heat content (OHC) against control model results (if available)</span>

<span class="na">...</span>

<span class="c1"># Months or seasons to plot (Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct,</span>
<span class="c1"># Nov, Dec, JFM, AMJ, JAS, OND, ANN)</span>
<span class="na">seasons</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="s">[&#39;ANN&#39;]</span>

<span class="c1"># comparison grid(s) (&#39;latlon&#39;, &#39;antarctic&#39;) on which to plot analysis</span>
<span class="na">comparisonGrids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[&#39;latlon&#39;]</span>

<span class="c1"># A list of pairs of minimum and maximum depths (positive up, in meters) to</span>
<span class="c1"># include in the vertical sums.  The default values are the equivalents of the</span>
<span class="c1"># default ranges of the timeSeriesOHCAnomaly task, with a value of -10,000 m</span>
<span class="c1"># intended to be well below the bottom of the ocean for all existing MPAS-O</span>
<span class="c1"># meshes.</span>
<span class="na">depthRanges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[(0.0, -10000.0), (0.0, -700.0), (-700.0, -2000.0), (-2000.0, -10000.0)]</span>
</pre></div>
</div>
<p>We plot only the annual mean OHC anomaly and we plot it only on a global
latitude-longitude grid.  The range of depths is:</p>
<ul class="simple">
<li><p>the full ocean column</p></li>
<li><p>sea surface to 700 m depth</p></li>
<li><p>700 m to 2000 m depth</p></li>
<li><p>2000 m to the seafloor</p></li>
</ul>
<p>A user would be free to change any of these config options, and the analysis
should run correctly.  They could choose to plot on a different comparison
grid, add new seasons, or change the depth range.  As long as they ran the
analysis in a fresh directory (or purged output from a previous analysis run),
this should work correctly.</p>
<p>Next, we store some values that will be useful later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mpas_field_name</span> <span class="o">=</span> <span class="s1">&#39;deltaOHC&#39;</span>

<span class="n">variable_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timeMonthly_avg_activeTracers_temperature&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;timeMonthly_avg_layerThickness&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>This particular analysis involves 4 different depth ranges over which we
compute the ocean heat content.  The remainder of the analysis is performed
separately for each of these depth ranges in subtask.  We loop over the
depth range and add a subtask that will first compute the ocean heat content
(OHC) and then remap it to the comparison grids (<code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">min_depth</span><span class="p">,</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">depth_ranges</span><span class="p">:</span>
    <span class="n">depth_range_string</span> <span class="o">=</span> \
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
    <span class="n">remap_climatology_subtask</span> <span class="o">=</span> <span class="n">RemapMpasOHCClimatology</span><span class="p">(</span>
        <span class="n">mpas_climatology_task</span><span class="o">=</span><span class="n">mpas_climatology_task</span><span class="p">,</span>
        <span class="n">ref_year_climatology_task</span><span class="o">=</span><span class="n">ref_year_climatology_task</span><span class="p">,</span>
        <span class="n">parent_task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">climatology_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">variable_list</span><span class="o">=</span><span class="n">variable_list</span><span class="p">,</span>
        <span class="n">comparison_grid_names</span><span class="o">=</span><span class="n">comparison_grid_names</span><span class="p">,</span>
        <span class="n">seasons</span><span class="o">=</span><span class="n">seasons</span><span class="p">,</span>
        <span class="n">min_depth</span><span class="o">=</span><span class="n">min_depth</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">add_subtask</span><span class="p">(</span><span class="n">remap_climatology_subtask</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>We will explore the <code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code> subtask later in the tutorial
so we will not discuss it further here.</p>
<p>Still within the loop over depth range, we then add a subtask
(<code class="docutils literal notranslate"><span class="pre">PlotClimatologyMapSubtask</span></code>) for plot we want to create, one for each each
comparison grid and season. (By default, there is only one comparison grid
and one “season”: the full year, <code class="docutils literal notranslate"><span class="pre">ANN</span></code>.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">min_depth</span><span class="p">,</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">depth_ranges</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">out_file_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;deltaOHC_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">remap_observations_subtask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">control_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref_title_label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ref_field_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">diff_title_label</span> <span class="o">=</span> <span class="s1">&#39;Model - Observations&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">control_run_name</span> <span class="o">=</span> <span class="n">control_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;mainRunName&#39;</span><span class="p">)</span>
        <span class="n">ref_title_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Control: </span><span class="si">{</span><span class="n">control_run_name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ref_field_name</span> <span class="o">=</span> <span class="n">mpas_field_name</span>
        <span class="n">diff_title_label</span> <span class="o">=</span> <span class="s1">&#39;Main - Control&#39;</span>

    <span class="k">for</span> <span class="n">comparison_grid_name</span> <span class="ow">in</span> <span class="n">comparison_grid_names</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">:</span>
            <span class="c1"># make a new subtask for this season and comparison grid</span>
            <span class="n">subtask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;plot</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">comparison_grid_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">subtask</span> <span class="o">=</span> <span class="n">PlotClimatologyMapSubtask</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">comparison_grid_name</span><span class="p">,</span>
                <span class="n">remap_climatology_subtask</span><span class="p">,</span> <span class="n">remap_observations_subtask</span><span class="p">,</span>
                <span class="n">controlConfig</span><span class="o">=</span><span class="n">control_config</span><span class="p">,</span> <span class="n">subtaskName</span><span class="o">=</span><span class="n">subtask_name</span><span class="p">)</span>

            <span class="n">subtask</span><span class="o">.</span><span class="n">set_plot_info</span><span class="p">(</span>
                <span class="n">outFileLabel</span><span class="o">=</span><span class="n">out_file_label</span><span class="p">,</span>
                <span class="n">fieldNameInTitle</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Delta$OHC over </span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">mpasFieldName</span><span class="o">=</span><span class="n">mpas_field_name</span><span class="p">,</span>
                <span class="n">refFieldName</span><span class="o">=</span><span class="n">ref_field_name</span><span class="p">,</span>
                <span class="n">refTitleLabel</span><span class="o">=</span><span class="n">ref_title_label</span><span class="p">,</span>
                <span class="n">diffTitleLabel</span><span class="o">=</span><span class="n">diff_title_label</span><span class="p">,</span>
                <span class="n">unitsLabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;GJ m$^{-2}$&#39;</span><span class="p">,</span>
                <span class="n">imageCaption</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Anomaly in Ocean Heat Content over </span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">galleryGroup</span><span class="o">=</span><span class="s1">&#39;OHC Anomaly&#39;</span><span class="p">,</span>
                <span class="n">groupSubtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">groupLink</span><span class="o">=</span><span class="s1">&#39;ohc_anom&#39;</span><span class="p">,</span>
                <span class="n">galleryName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_subtask</span><span class="p">(</span><span class="n">subtask</span><span class="p">)</span>
</pre></div>
</div>
<p>First, we make sure the subtask has a unique name.  If two tasks or subtasks
have the same <code class="docutils literal notranslate"><span class="pre">taskName</span></code> and <code class="docutils literal notranslate"><span class="pre">subtaskName</span></code>, MPAS-Analysis will only run
the last one and the task manager may become confused.</p>
<p>Then, we create a <code class="docutils literal notranslate"><span class="pre">subtask</span></code> object that is an instance of the
<code class="xref py py-class docutils literal notranslate"><span class="pre">PlotClimatologyMapSubtask</span></code>
class.  This class is shared between several ocean analysis tasks for plotting
climatologies as horizontal maps.  It can plot just MPAS output, remapped to
one or more comparison grids and averaged over one or more seasons.  It can
also plot that data against an observational field that has been remapped to
the same comparison grid and averaged over the same seasons.  In this case,
there are no observations available for comparison
(<code class="docutils literal notranslate"><span class="pre">remap_observations_subtask</span> <span class="pre">=</span> <span class="pre">None</span></code>).  A user may have provided a
“control” run of MPAS-Analysis to compare with this analysis run (a so-called
“model vs. model” comparison).  If so, <code class="docutils literal notranslate"><span class="pre">control_config</span></code> will have config
options describing the other analysis run.  If not, <code class="docutils literal notranslate"><span class="pre">control_config</span></code> is
<code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<p>Next, We call the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_plot_info()</span></code>
method of <code class="xref py py-class docutils literal notranslate"><span class="pre">PlotClimatologyMapSubtask</span></code>
to provide things like the title and units for the plot and the field to plot.
We also provide information needed for the final analysis web page such as the
name of the gallery group.  (We do not provide a gallery name within the
gallery group because there will be no other galleries within this group.)
All the plots for a given comparison grid will end up in the same gallery,
with different depths and seasons one after the other.</p>
<p>Finally, we call <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.add_subtask.html#mpas_analysis.shared.AnalysisTask.add_subtask" title="mpas_analysis.shared.AnalysisTask.add_subtask"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_subtask()</span></code></a>
to add the <code class="docutils literal notranslate"><span class="pre">subtask</span></code> to this task.</p>
</section>
<section id="setup-and-check-method">
<h3>2.3 <code class="docutils literal notranslate"><span class="pre">setup_and_check()</span></code> method<a class="headerlink" href="#setup-and-check-method" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">setup_and_check()</span></code> method of an analysis task is called when it is clear
that this particular analysis has been requested (but before the analysis is
actually ready to run).  This is in contrast to the constructor, which is
run for <em>every</em> analysis task everytime MPAS-Analysis runs because we need
information from the analysis task (its name, component and tags) in order to
determine if it should run or not.</p>
<p>In this method, we would typically perform checks to make sure the simulation
has been configured properly to run the analysis.  For example, is the
necessary analysis member enabled.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether analysis is being performed only on the reference year,</span>
<span class="sd">    in which case the analysis will not be meaningful.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError: if attempting to analyze only the reference year</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># first, call setup_and_check from the base class (AnalysisTask),</span>
    <span class="c1"># which will perform some common setup, including storing:</span>
    <span class="c1">#     self.runDirectory , self.historyDirectory, self.plotsDirectory,</span>
    <span class="c1">#     self.namelist, self.runStreams, self.historyStreams,</span>
    <span class="c1">#     self.calendar</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>

    <span class="n">start_year</span><span class="p">,</span> <span class="n">end_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpas_climatology_task</span><span class="o">.</span><span class="n">get_start_and_end</span><span class="p">()</span>
    <span class="n">ref_start_year</span><span class="p">,</span> <span class="n">ref_end_year</span> <span class="o">=</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">get_start_and_end</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">start_year</span> <span class="o">==</span> <span class="n">ref_start_year</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">end_year</span> <span class="o">==</span> <span class="n">ref_end_year</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;OHC Anomaly is not meaningful and will not work &#39;</span>
                         <span class="s1">&#39;when climatology and ref year are the same.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this particular case, we first call the super class’ version of the
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.setup_and_check.html#mpas_analysis.shared.AnalysisTask.setup_and_check" title="mpas_analysis.shared.AnalysisTask.setup_and_check"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_and_check()</span></code></a> method.  This
takes care of some important setup.</p>
<p>Then, we use this method to check if the user has specified meaningful values
for the climatology start and end year and the reference year.  If they happen
to be the same, it doesn’t really make sense to run the analysis and it will
raise an error so the analysis gets skipped.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code> has delegated all its work to its subtasks
so it doesn’t define a <code class="docutils literal notranslate"><span class="pre">run_task()</span></code> method. Tasks or subtasks that actually
do the work typically need to define this method, as we will explore below.</p>
</section>
</section>
<section id="tour-of-a-subtask-remapmpasohcclimatology">
<h2>3. Tour of a subtask (<code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code>)<a class="headerlink" href="#tour-of-a-subtask-remapmpasohcclimatology" title="Link to this heading"></a></h2>
<p>The class <code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code> is, in some ways, more complicated than
its “parent” task <a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a>.
It descends not from the <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a> base
class but from another subtask,
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a>.
This tutorial won’t attempt to cover
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a> in
all its detail.  The basics are that that class starts with MPAS climatology
data over one or more <code class="docutils literal notranslate"><span class="pre">seasons</span></code> that has previously been computed by an
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.MpasClimatologyTask.html#mpas_analysis.shared.climatology.MpasClimatologyTask" title="mpas_analysis.shared.climatology.MpasClimatologyTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">MpasClimatologyTask</span></code></a> task.  It
remaps that data from the MPAS mesh to one or more comparison grids (e.g.
global latitude-longitude or Antarctic stereographic) where it can be plotted
and compared with observations or another MPAS-Analysis run.</p>
<p>Here, we are not just using
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a>
directly because we need to add to its functionality.  We need to compute the
OHC, which is not available straight from MPAS-Ocean output, from the
monthly-mean temperature and layer thickness.</p>
<section id="id1">
<h3>3.1 Attributes<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>The docstring indicates the attributes that <code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code>
includes.  (It also has all the attributes of its super class,
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a>,
and that class’ super class, <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a>,
but we don’t redundantly document these in the docstring in part because that
would be a maintenance nightmare.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RemapMpasOHCClimatology</span><span class="p">(</span><span class="n">RemapMpasClimatologySubtask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A subtask for computing climatologies of ocean heat content from</span>
<span class="sd">    climatologies of temperature</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology from the first year to be</span>
<span class="sd">        remapped and then subtracted from the main climatology</span>

<span class="sd">    min_depth, max_depth : float</span>
<span class="sd">        The minimum and maximum depths for integration</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The attributes are a task for computing the climatology over the reference
year (usually the start of the simulation), <code class="docutils literal notranslate"><span class="pre">ref_year_climatology_task</span></code>,
and the minimum and maximum depth over which the ocean heat content will be
integrated.</p>
</section>
<section id="id2">
<h3>3.2 Constructor<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpas_climatology_task</span><span class="p">,</span> <span class="n">ref_year_climatology_task</span><span class="p">,</span>
             <span class="n">parent_task</span><span class="p">,</span> <span class="n">climatology_name</span><span class="p">,</span> <span class="n">variable_list</span><span class="p">,</span> <span class="n">seasons</span><span class="p">,</span>
             <span class="n">comparison_grid_names</span><span class="p">,</span> <span class="n">min_depth</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the analysis task and adds it as a subtask of the</span>
<span class="sd">    ``parent_task``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mpas_climatology_task : mpas_analysis.shared.climatology.MpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology to be remapped</span>

<span class="sd">    ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology from the first year to be</span>
<span class="sd">        remapped and then subtracted from the main climatology</span>

<span class="sd">    parent_task :  mpas_analysis.shared.AnalysisTask</span>
<span class="sd">        The parent task, used to get the ``taskName``, ``config`` and</span>
<span class="sd">        ``componentName``</span>

<span class="sd">    climatology_name : str</span>
<span class="sd">        A name that describes the climatology (e.g. a short version of</span>
<span class="sd">        the important field(s) in the climatology) used to name the</span>
<span class="sd">        subdirectories for each stage of the climatology</span>

<span class="sd">    variable_list : list of str</span>
<span class="sd">        A list of variable names in ``timeSeriesStatsMonthly`` to be</span>
<span class="sd">        included in the climatologies</span>

<span class="sd">    seasons : list of str, optional</span>
<span class="sd">        A list of seasons (keys in ``shared.constants.monthDictionary``)</span>
<span class="sd">        to be computed or [&#39;none&#39;] (not ``None``) if only monthly</span>
<span class="sd">        climatologies are needed.</span>

<span class="sd">    comparison_grid_names : list of {&#39;latlon&#39;, &#39;antarctic&#39;}</span>
<span class="sd">        The name(s) of the comparison grid to use for remapping.</span>

<span class="sd">    min_depth, max_depth : float</span>
<span class="sd">        The minimum and maximum depths for integration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">depth_range_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
    <span class="n">subtask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;remapMpasClimatology_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="c1"># call the constructor from the base class</span>
    <span class="c1"># (RemapMpasClimatologySubtask)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">mpas_climatology_task</span><span class="p">,</span> <span class="n">parent_task</span><span class="p">,</span> <span class="n">climatology_name</span><span class="p">,</span>
        <span class="n">variable_list</span><span class="p">,</span> <span class="n">seasons</span><span class="p">,</span> <span class="n">comparison_grid_names</span><span class="p">,</span>
        <span class="n">subtaskName</span><span class="o">=</span><span class="n">subtask_name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span> <span class="o">=</span> <span class="n">ref_year_climatology_task</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_after</span><span class="p">(</span><span class="n">ref_year_climatology_task</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span> <span class="o">=</span> <span class="n">min_depth</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
</pre></div>
</div>
<p>Most of the arguments to the constructor are passed along to the constructor
of <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a>.
These include a reference to the class for computing MPAS climatologies
(used to find the input files and to make sure this task waits until that
task is finished), a reference to the “parent”
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a> task for some of its
attributes, the name of the climatology supplied by the parent (something like
<code class="docutils literal notranslate"><span class="pre">deltaOHC_0-700m</span></code>, depending on the depth range), a list of the variables
that go into computing the OHC, the season(s) over which the climatology was
requested, the comparison grid(s) to plot on and a unique name for this
subtask.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ref_year_climatology_task</span></code> that computing the climatology over the
reference year is retained as an attribute to the class along with
the depth range.  These attributes will all be needed later when we compute the
OHC.  We indicate that this task must wait for the reference climatology to be
available by calling the <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.run_after.html#mpas_analysis.shared.AnalysisTask.run_after" title="mpas_analysis.shared.AnalysisTask.run_after"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_after()</span></code></a>.
The super class will do the same for the <code class="docutils literal notranslate"><span class="pre">mpas_climatology_task</span></code> task.  It
will also add this task as a subtask of the parent task.</p>
</section>
<section id="id3">
<h3>3.3 <code class="docutils literal notranslate"><span class="pre">setup_and_check()</span></code> method<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>As in the parent task, we need to define the <code class="docutils literal notranslate"><span class="pre">setup_and_check()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform steps to set up the analysis and check for errors in the setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># first, call setup_and_check from the base class</span>
    <span class="c1"># (RemapMpasClimatologySubtask), which will set up remappers and add</span>
    <span class="c1"># variables to mpas_climatology_task</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>

    <span class="c1"># don&#39;t add the variables and seasons to mpas_climatology_task until</span>
    <span class="c1"># we&#39;re sure this subtask is supposed to run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">add_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variableList</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span>
</pre></div>
</div>
<p>In this particular case, we first call the super class’ version of the
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.setup_and_check.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.setup_and_check" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.setup_and_check"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup_and_check()</span></code></a>
method.  This takes care of some important setup including adding the variables
and season(s) we need to the <code class="docutils literal notranslate"><span class="pre">mpas_climatology_task</span></code>.</p>
<p>Then, we use this method to add variables we need
and the requested season(s) to the task for computing the climatology over the
reference year (<code class="docutils literal notranslate"><span class="pre">ref_year_climatology_task</span></code>).  We don’t do this in the
constructor because if we did, we would always be asking for the variables
needed to compute the OHC even if we don’t actually end up computing it.  This
could be a big waste of time and disk space.  The super class
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a> can’t
take care of this for us because it isn’t designed for computing anomalies,
just “normal” climatologies over a range of years.</p>
</section>
<section id="run-task-method">
<span id="tutorial-understand-a-task-subtask-run-task"></span><h3>3.4 <code class="docutils literal notranslate"><span class="pre">run_task()</span></code> method<a class="headerlink" href="#run-task-method" title="Link to this heading"></a></h3>
<p>Normally, the main work of a task happens in the <code class="docutils literal notranslate"><span class="pre">run_task()</span></code> method.
The <code class="docutils literal notranslate"><span class="pre">RemapMpasOHCClimatology</span></code> class doesn’t define this method because it is
happy to inherit the
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.run_task.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.run_task" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.run_task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_task()</span></code></a>
method from its super class,
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a>.</p>
<p>An abbreviated version of that method looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the requested climatologies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_climatologies</span><span class="p">(</span><span class="n">season</span><span class="p">,</span> <span class="n">dsMask</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>It calls a private helper method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_mask_climatologies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">dsMask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each season, creates a masked version of the climatology</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maskedClimatologyFileName</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="c1"># customize (if this function has been overridden)</span>
        <span class="n">climatology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customize_masked_climatology</span><span class="p">(</span><span class="n">climatology</span><span class="p">,</span>
                                                        <span class="n">season</span><span class="p">)</span>

        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">climatology</span><span class="p">,</span> <span class="n">maskedClimatologyFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>This private method (the leading underscore indicates that it is private), in
turn, calls the <code class="docutils literal notranslate"><span class="pre">customize_masked_climatology()</span></code> method, which is our chance
to make changes to the climatology before it gets remapped.  That’s where
we will actually compute the OHC from variables available from MPAS output.</p>
</section>
<section id="customize-masked-climatology-method">
<h3>3.5 <code class="docutils literal notranslate"><span class="pre">customize_masked_climatology()</span></code> method<a class="headerlink" href="#customize-masked-climatology-method" title="Link to this heading"></a></h3>
<p>Here is how we compute the OHC itself:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">customize_masked_climatology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">climatology</span><span class="p">,</span> <span class="n">season</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the ocean heat content (OHC) anomaly from the temperature</span>
<span class="sd">    and layer thickness fields.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    climatology : xarray.Dataset</span>
<span class="sd">        the climatology data set</span>

<span class="sd">    season : str</span>
<span class="sd">        The name of the season to be masked</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    climatology : xarray.Dataset</span>
<span class="sd">        the modified climatology data set</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ohc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ohc</span><span class="p">(</span><span class="n">climatology</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>We call a private helper method to do the actual work, so let’s take a look
at that before we continue with <code class="docutils literal notranslate"><span class="pre">customize_masked_climatology()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_compute_ohc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">climatology</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the OHC from the temperature and layer thicknesses in a given</span>
<span class="sd">    climatology data sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds_restart</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartFileName</span><span class="p">)</span>
    <span class="n">ds_restart</span> <span class="o">=</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># specific heat [J/(kg*degC)]</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;config_specific_heat_sea_water&#39;</span><span class="p">)</span>
    <span class="c1"># [kg/m3]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;config_density0&#39;</span><span class="p">)</span>

    <span class="n">units_scale_factor</span> <span class="o">=</span> <span class="mf">1e-9</span>

    <span class="n">n_vert_levels</span> <span class="o">=</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">]</span>

    <span class="n">z_mid</span> <span class="o">=</span> <span class="n">compute_zmid</span><span class="p">(</span><span class="n">ds_restart</span><span class="o">.</span><span class="n">bottomDepth</span><span class="p">,</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">maxLevelCell</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">ds_restart</span><span class="o">.</span><span class="n">layerThickness</span><span class="p">)</span>

    <span class="n">vert_index</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">,),</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_vert_levels</span><span class="p">)})</span>

    <span class="n">temperature</span> <span class="o">=</span> <span class="n">climatology</span><span class="p">[</span><span class="s1">&#39;timeMonthly_avg_activeTracers_temperature&#39;</span><span class="p">]</span>
    <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">climatology</span><span class="p">[</span><span class="s1">&#39;timeMonthly_avg_layerThickness&#39;</span><span class="p">]</span>

    <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vert_index</span> <span class="o">&lt;</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">maxLevelCell</span><span class="p">,</span>
             <span class="n">z_mid</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span><span class="p">,</span>
             <span class="n">z_mid</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">layer_thickness</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="n">ohc</span> <span class="o">=</span> <span class="n">units_scale_factor</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">layer_thickness</span> <span class="o">*</span> <span class="n">temperature</span>
    <span class="n">ohc</span> <span class="o">=</span> <span class="n">ohc</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ohc</span>
</pre></div>
</div>
<p>This function uses a combination of mesh information taken from an MPAS
restart file (available from the <code class="docutils literal notranslate"><span class="pre">self.restartFileName</span></code> attribute inherited
from <a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.climatology.RemapMpasClimatologySubtask.html#mpas_analysis.shared.climatology.RemapMpasClimatologySubtask" title="mpas_analysis.shared.climatology.RemapMpasClimatologySubtask"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemapMpasClimatologySubtask</span></code></a>),
namelist options available from the <code class="docutils literal notranslate"><span class="pre">self.namelist</span></code> reader (inherited from
<a class="reference internal" href="../developers_guide/generated/mpas_analysis.shared.AnalysisTask.html#mpas_analysis.shared.AnalysisTask" title="mpas_analysis.shared.AnalysisTask"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnalysisTask</span></code></a>), and <code class="docutils literal notranslate"><span class="pre">temperature</span></code> and
<code class="docutils literal notranslate"><span class="pre">layer_thickness</span></code> from the <code class="docutils literal notranslate"><span class="pre">climatology</span></code> dataset itself.  As the
docstring for <code class="docutils literal notranslate"><span class="pre">customize_masked_climatology()</span></code> states, <code class="docutils literal notranslate"><span class="pre">climatology</span></code> is
and <a class="reference external" href="https://docs.xarray.dev/en/stable/generated/xarray.Dataset.html#xarray.Dataset" title="(in xarray v2024.11.1.dev0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">xarray.Dataset</span></code></a>.  We know it has variables
<code class="docutils literal notranslate"><span class="pre">timeMonthly_avg_activeTracers_temperature</span></code> and
<code class="docutils literal notranslate"><span class="pre">timeMonthly_avg_layerThickness</span></code> because we requested them back in the
constructor of <a class="reference internal" href="../developers_guide/generated/mpas_analysis.ocean.ClimatologyMapOHCAnomaly.html#mpas_analysis.ocean.ClimatologyMapOHCAnomaly" title="mpas_analysis.ocean.ClimatologyMapOHCAnomaly"><code class="xref py py-class docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code></a>.
We compute the <code class="docutils literal notranslate"><span class="pre">ohc</span></code> as an <a class="reference external" href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.html#xarray.DataArray" title="(in xarray v2024.11.1.dev0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">xarray.DataArray</span></code></a> that we return from
this helper method.</p>
<p>Back to <code class="docutils literal notranslate"><span class="pre">customize_masked_climatology()</span></code>, we have:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">customize_masked_climatology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">climatology</span><span class="p">,</span> <span class="n">season</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">ohc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ohc</span><span class="p">(</span><span class="n">climatology</span><span class="p">)</span>

    <span class="n">ref_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">get_file_name</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
    <span class="n">ref_year_climo</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">ref_file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;Time&#39;</span> <span class="ow">in</span> <span class="n">ref_year_climo</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">ref_year_climo</span> <span class="o">=</span> <span class="n">ref_year_climo</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ref_ohc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ohc</span><span class="p">(</span><span class="n">ref_year_climo</span><span class="p">)</span>

    <span class="n">climatology</span><span class="p">[</span><span class="s1">&#39;deltaOHC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ohc</span> <span class="o">-</span> <span class="n">ref_ohc</span>
    <span class="n">climatology</span><span class="o">.</span><span class="n">deltaOHC</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GJ m^-2$&#39;</span>
    <span class="n">start_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">startYear</span>
    <span class="n">climatology</span><span class="o">.</span><span class="n">deltaOHC</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="sa">f</span><span class="s1">&#39;Anomaly from year </span><span class="si">{</span><span class="n">start_year</span><span class="si">}</span><span class="s1"> in ocean heat content&#39;</span>
    <span class="n">climatology</span> <span class="o">=</span> <span class="n">climatology</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variableList</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">climatology</span>
</pre></div>
</div>
<p>We use the same helper function to compute the <code class="docutils literal notranslate"><span class="pre">ref_ohc</span></code> using the
climatology for the reference year.  Then, we compute the anomaly (the
difference between these two, <code class="docutils literal notranslate"><span class="pre">deltaOHC</span></code>) and we add some attributes,
<code class="docutils literal notranslate"><span class="pre">units</span></code> and <code class="docutils literal notranslate"><span class="pre">description</span></code>, to make the NetCDF output that will go into the
analysis output directory a little more useful.</p>
</section>
</section>
<section id="the-full-code-for-posterity">
<h2>4. The full code for posterity<a class="headerlink" href="#the-full-code-for-posterity" title="Link to this heading"></a></h2>
<p>Since the <code class="docutils literal notranslate"><span class="pre">ClimatologyMapOHCAnomaly</span></code> analysis task may evolve in the future,
here is the full analysis task as described in this tutorial:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This software is open source software available under the BSD-3 license.</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2022 Triad National Security, LLC. All rights reserved.</span>
<span class="c1"># Copyright (c) 2022 Lawrence Livermore National Security, LLC. All rights</span>
<span class="c1"># reserved.</span>
<span class="c1"># Copyright (c) 2022 UT-Battelle, LLC. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Additional copyright and license information can be found in the LICENSE file</span>
<span class="c1"># distributed with this code, or at</span>
<span class="c1"># https://raw.githubusercontent.com/MPAS-Dev/MPAS-Analysis/main/LICENSE</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">mpas_analysis.shared</span> <span class="kn">import</span> <span class="n">AnalysisTask</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.shared.climatology</span> <span class="kn">import</span> <span class="n">RemapMpasClimatologySubtask</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.ocean.plot_climatology_map_subtask</span> <span class="kn">import</span> \
    <span class="n">PlotClimatologyMapSubtask</span>
<span class="kn">from</span> <span class="nn">mpas_analysis.ocean.utility</span> <span class="kn">import</span> <span class="n">compute_zmid</span>


<span class="k">class</span> <span class="nc">ClimatologyMapOHCAnomaly</span><span class="p">(</span><span class="n">AnalysisTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An analysis task for comparison of the anomaly from a reference year</span>
<span class="sd">    (typically the start of the simulation) of ocean heat content (OHC)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mpas_climatology_task : mpas_analysis.shared.climatology.MpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology to be remapped and plotted</span>

<span class="sd">    ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology from the first year to be</span>
<span class="sd">        remapped and then subtracted from the main climatology</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">mpas_climatology_task</span><span class="p">,</span>
                 <span class="n">ref_year_climatology_task</span><span class="p">,</span> <span class="n">control_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the analysis task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config : mpas_tools.config.MpasConfigParser</span>
<span class="sd">            Configuration options</span>

<span class="sd">        mpas_climatology_task : mpas_analysis.shared.climatology.MpasClimatologyTask</span>
<span class="sd">            The task that produced the climatology to be remapped and plotted</span>

<span class="sd">        ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">            The task that produced the climatology from the first year to be</span>
<span class="sd">            remapped and then subtracted from the main climatology</span>

<span class="sd">        control_config : mpas_tools.config.MpasConfigParser, optional</span>
<span class="sd">            Configuration options for a control run (if any)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_name</span> <span class="o">=</span> <span class="s1">&#39;deltaOHC&#39;</span>
        <span class="c1"># call the constructor from the base class (AnalysisTask)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">taskName</span><span class="o">=</span><span class="s1">&#39;climatologyMapOHCAnomaly&#39;</span><span class="p">,</span>
                         <span class="n">componentName</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
                         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;climatology&#39;</span><span class="p">,</span> <span class="s1">&#39;horizontalMap&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span>
                               <span class="s1">&#39;publicObs&#39;</span><span class="p">,</span> <span class="s1">&#39;anomaly&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mpas_climatology_task</span> <span class="o">=</span> <span class="n">mpas_climatology_task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span> <span class="o">=</span> <span class="n">ref_year_climatology_task</span>

        <span class="n">section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskName</span>

        <span class="c1"># read in what seasons we want to plot</span>
        <span class="n">seasons</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;seasons&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seasons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config section </span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s1"> does not contain &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;valid list of seasons&#39;</span><span class="p">)</span>

        <span class="n">comparison_grid_names</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span>
                                                     <span class="s1">&#39;comparisonGrids&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison_grid_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;config section </span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s1"> does not contain &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;valid list of comparison grids&#39;</span><span class="p">)</span>

        <span class="n">depth_ranges</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getexpression</span><span class="p">(</span><span class="s1">&#39;climatologyMapOHCAnomaly&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;depthRanges&#39;</span><span class="p">,</span>
                                            <span class="n">use_numpyfunc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">mpas_field_name</span> <span class="o">=</span> <span class="s1">&#39;deltaOHC&#39;</span>

        <span class="n">variable_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timeMonthly_avg_activeTracers_temperature&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;timeMonthly_avg_layerThickness&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">min_depth</span><span class="p">,</span> <span class="n">max_depth</span> <span class="ow">in</span> <span class="n">depth_ranges</span><span class="p">:</span>
            <span class="n">depth_range_string</span> <span class="o">=</span> \
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
            <span class="n">remap_climatology_subtask</span> <span class="o">=</span> <span class="n">RemapMpasOHCClimatology</span><span class="p">(</span>
                <span class="n">mpas_climatology_task</span><span class="o">=</span><span class="n">mpas_climatology_task</span><span class="p">,</span>
                <span class="n">ref_year_climatology_task</span><span class="o">=</span><span class="n">ref_year_climatology_task</span><span class="p">,</span>
                <span class="n">parent_task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">climatology_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">variable_list</span><span class="o">=</span><span class="n">variable_list</span><span class="p">,</span>
                <span class="n">comparison_grid_names</span><span class="o">=</span><span class="n">comparison_grid_names</span><span class="p">,</span>
                <span class="n">seasons</span><span class="o">=</span><span class="n">seasons</span><span class="p">,</span>
                <span class="n">min_depth</span><span class="o">=</span><span class="n">min_depth</span><span class="p">,</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_subtask</span><span class="p">(</span><span class="n">remap_climatology_subtask</span><span class="p">)</span>

            <span class="n">out_file_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;deltaOHC_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">remap_observations_subtask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">control_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref_title_label</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ref_field_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">diff_title_label</span> <span class="o">=</span> <span class="s1">&#39;Model - Observations&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_run_name</span> <span class="o">=</span> <span class="n">control_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;mainRunName&#39;</span><span class="p">)</span>
                <span class="n">ref_title_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Control: </span><span class="si">{</span><span class="n">control_run_name</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">ref_field_name</span> <span class="o">=</span> <span class="n">mpas_field_name</span>
                <span class="n">diff_title_label</span> <span class="o">=</span> <span class="s1">&#39;Main - Control&#39;</span>

            <span class="k">for</span> <span class="n">comparison_grid_name</span> <span class="ow">in</span> <span class="n">comparison_grid_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">:</span>
                    <span class="c1"># make a new subtask for this season and comparison grid</span>
                    <span class="n">subtask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;plot</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">comparison_grid_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span>

                    <span class="n">subtask</span> <span class="o">=</span> <span class="n">PlotClimatologyMapSubtask</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">comparison_grid_name</span><span class="p">,</span>
                        <span class="n">remap_climatology_subtask</span><span class="p">,</span> <span class="n">remap_observations_subtask</span><span class="p">,</span>
                        <span class="n">controlConfig</span><span class="o">=</span><span class="n">control_config</span><span class="p">,</span> <span class="n">subtaskName</span><span class="o">=</span><span class="n">subtask_name</span><span class="p">)</span>

                    <span class="n">subtask</span><span class="o">.</span><span class="n">set_plot_info</span><span class="p">(</span>
                        <span class="n">outFileLabel</span><span class="o">=</span><span class="n">out_file_label</span><span class="p">,</span>
                        <span class="n">fieldNameInTitle</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Delta$OHC over </span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">mpasFieldName</span><span class="o">=</span><span class="n">mpas_field_name</span><span class="p">,</span>
                        <span class="n">refFieldName</span><span class="o">=</span><span class="n">ref_field_name</span><span class="p">,</span>
                        <span class="n">refTitleLabel</span><span class="o">=</span><span class="n">ref_title_label</span><span class="p">,</span>
                        <span class="n">diffTitleLabel</span><span class="o">=</span><span class="n">diff_title_label</span><span class="p">,</span>
                        <span class="n">unitsLabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;GJ m$^{-2}$&#39;</span><span class="p">,</span>
                        <span class="n">imageCaption</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Anomaly in Ocean Heat Content over </span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">galleryGroup</span><span class="o">=</span><span class="s1">&#39;OHC Anomaly&#39;</span><span class="p">,</span>
                        <span class="n">groupSubtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">groupLink</span><span class="o">=</span><span class="s1">&#39;ohc_anom&#39;</span><span class="p">,</span>
                        <span class="n">galleryName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">add_subtask</span><span class="p">(</span><span class="n">subtask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether analysis is being performed only on the reference year,</span>
<span class="sd">        in which case the analysis will not be meaningful.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError: if attempting to analyze only the reference year</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first, call setup_and_check from the base class (AnalysisTask),</span>
        <span class="c1"># which will perform some common setup, including storing:</span>
        <span class="c1">#     self.runDirectory , self.historyDirectory, self.plotsDirectory,</span>
        <span class="c1">#     self.namelist, self.runStreams, self.historyStreams,</span>
        <span class="c1">#     self.calendar</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>

        <span class="n">start_year</span><span class="p">,</span> <span class="n">end_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpas_climatology_task</span><span class="o">.</span><span class="n">get_start_and_end</span><span class="p">()</span>
        <span class="n">ref_start_year</span><span class="p">,</span> <span class="n">ref_end_year</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">get_start_and_end</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">start_year</span> <span class="o">==</span> <span class="n">ref_start_year</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">end_year</span> <span class="o">==</span> <span class="n">ref_end_year</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;OHC Anomaly is not meaningful and will not work &#39;</span>
                             <span class="s1">&#39;when climatology and ref year are the same.&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RemapMpasOHCClimatology</span><span class="p">(</span><span class="n">RemapMpasClimatologySubtask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A subtask for computing climatologies of ocean heat content from</span>
<span class="sd">    climatologies of temperature</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">        The task that produced the climatology from the first year to be</span>
<span class="sd">        remapped and then subtracted from the main climatology</span>

<span class="sd">    min_depth, max_depth : float</span>
<span class="sd">        The minimum and maximum depths for integration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpas_climatology_task</span><span class="p">,</span> <span class="n">ref_year_climatology_task</span><span class="p">,</span>
                 <span class="n">parent_task</span><span class="p">,</span> <span class="n">climatology_name</span><span class="p">,</span> <span class="n">variable_list</span><span class="p">,</span> <span class="n">seasons</span><span class="p">,</span>
                 <span class="n">comparison_grid_names</span><span class="p">,</span> <span class="n">min_depth</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the analysis task and adds it as a subtask of the</span>
<span class="sd">        ``parent_task``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mpas_climatology_task : mpas_analysis.shared.climatology.MpasClimatologyTask</span>
<span class="sd">            The task that produced the climatology to be remapped</span>

<span class="sd">        ref_year_climatology_task : mpas_analysis.shared.climatology.RefYearMpasClimatologyTask</span>
<span class="sd">            The task that produced the climatology from the first year to be</span>
<span class="sd">            remapped and then subtracted from the main climatology</span>

<span class="sd">        parent_task :  mpas_analysis.shared.AnalysisTask</span>
<span class="sd">            The parent task, used to get the ``taskName``, ``config`` and</span>
<span class="sd">            ``componentName``</span>

<span class="sd">        climatology_name : str</span>
<span class="sd">            A name that describes the climatology (e.g. a short version of</span>
<span class="sd">            the important field(s) in the climatology) used to name the</span>
<span class="sd">            subdirectories for each stage of the climatology</span>

<span class="sd">        variable_list : list of str</span>
<span class="sd">            A list of variable names in ``timeSeriesStatsMonthly`` to be</span>
<span class="sd">            included in the climatologies</span>

<span class="sd">        seasons : list of str, optional</span>
<span class="sd">            A list of seasons (keys in ``shared.constants.monthDictionary``)</span>
<span class="sd">            to be computed or [&#39;none&#39;] (not ``None``) if only monthly</span>
<span class="sd">            climatologies are needed.</span>

<span class="sd">        comparison_grid_names : list of {&#39;latlon&#39;, &#39;antarctic&#39;}</span>
<span class="sd">            The name(s) of the comparison grid to use for remapping.</span>

<span class="sd">        min_depth, max_depth : float</span>
<span class="sd">            The minimum and maximum depths for integration</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">depth_range_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_depth</span><span class="p">)</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
        <span class="n">subtask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;remapMpasClimatology_</span><span class="si">{</span><span class="n">depth_range_string</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="c1"># call the constructor from the base class</span>
        <span class="c1"># (RemapMpasClimatologySubtask)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">mpas_climatology_task</span><span class="p">,</span> <span class="n">parent_task</span><span class="p">,</span> <span class="n">climatology_name</span><span class="p">,</span>
            <span class="n">variable_list</span><span class="p">,</span> <span class="n">seasons</span><span class="p">,</span> <span class="n">comparison_grid_names</span><span class="p">,</span>
            <span class="n">subtaskName</span><span class="o">=</span><span class="n">subtask_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span> <span class="o">=</span> <span class="n">ref_year_climatology_task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_after</span><span class="p">(</span><span class="n">ref_year_climatology_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span> <span class="o">=</span> <span class="n">min_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>

    <span class="k">def</span> <span class="nf">setup_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform steps to set up the analysis and check for errors in the setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first, call setup_and_check from the base class</span>
        <span class="c1"># (RemapMpasClimatologySubtask), which will set up remappers and add</span>
        <span class="c1"># variables to mpas_climatology_task</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_and_check</span><span class="p">()</span>

        <span class="c1"># don&#39;t add the variables and seasons to mpas_climatology_task until</span>
        <span class="c1"># we&#39;re sure this subtask is supposed to run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">add_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variableList</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">customize_masked_climatology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">climatology</span><span class="p">,</span> <span class="n">season</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the ocean heat content (OHC) anomaly from the temperature</span>
<span class="sd">        and layer thickness fields.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        climatology : xarray.Dataset</span>
<span class="sd">            the climatology data set</span>

<span class="sd">        season : str</span>
<span class="sd">            The name of the season to be masked</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        climatology : xarray.Dataset</span>
<span class="sd">            the modified climatology data set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ohc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ohc</span><span class="p">(</span><span class="n">climatology</span><span class="p">)</span>
        <span class="n">ref_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">get_file_name</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
        <span class="n">ref_year_climo</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">ref_file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Time&#39;</span> <span class="ow">in</span> <span class="n">ref_year_climo</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ref_year_climo</span> <span class="o">=</span> <span class="n">ref_year_climo</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ref_ohc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ohc</span><span class="p">(</span><span class="n">ref_year_climo</span><span class="p">)</span>

        <span class="n">climatology</span><span class="p">[</span><span class="s1">&#39;deltaOHC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ohc</span> <span class="o">-</span> <span class="n">ref_ohc</span>
        <span class="n">climatology</span><span class="o">.</span><span class="n">deltaOHC</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GJ m^-2&#39;</span>
        <span class="n">start_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_year_climatology_task</span><span class="o">.</span><span class="n">startYear</span>
        <span class="n">climatology</span><span class="o">.</span><span class="n">deltaOHC</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="sa">f</span><span class="s1">&#39;Anomaly from year </span><span class="si">{</span><span class="n">start_year</span><span class="si">}</span><span class="s1"> in ocean heat content&#39;</span>
        <span class="n">climatology</span> <span class="o">=</span> <span class="n">climatology</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variableList</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">climatology</span>

    <span class="k">def</span> <span class="nf">_compute_ohc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">climatology</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the OHC from the temperature and layer thicknesses in a given</span>
<span class="sd">        climatology data sets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds_restart</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restartFileName</span><span class="p">)</span>
        <span class="n">ds_restart</span> <span class="o">=</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># specific heat [J/(kg*degC)]</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;config_specific_heat_sea_water&#39;</span><span class="p">)</span>
        <span class="c1"># [kg/m3]</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;config_density0&#39;</span><span class="p">)</span>

        <span class="n">units_scale_factor</span> <span class="o">=</span> <span class="mf">1e-9</span>

        <span class="n">n_vert_levels</span> <span class="o">=</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">]</span>

        <span class="n">z_mid</span> <span class="o">=</span> <span class="n">compute_zmid</span><span class="p">(</span><span class="n">ds_restart</span><span class="o">.</span><span class="n">bottomDepth</span><span class="p">,</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">maxLevelCell</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">ds_restart</span><span class="o">.</span><span class="n">layerThickness</span><span class="p">)</span>

        <span class="n">vert_index</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">,),</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_vert_levels</span><span class="p">)})</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="n">climatology</span><span class="p">[</span><span class="s1">&#39;timeMonthly_avg_activeTracers_temperature&#39;</span><span class="p">]</span>
        <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">climatology</span><span class="p">[</span><span class="s1">&#39;timeMonthly_avg_layerThickness&#39;</span><span class="p">]</span>

        <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vert_index</span> <span class="o">&lt;</span> <span class="n">ds_restart</span><span class="o">.</span><span class="n">maxLevelCell</span><span class="p">,</span>
                 <span class="n">z_mid</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_depth</span><span class="p">,</span>
                 <span class="n">z_mid</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">layer_thickness</span> <span class="o">=</span> <span class="n">layer_thickness</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">ohc</span> <span class="o">=</span> <span class="n">units_scale_factor</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">cp</span> <span class="o">*</span> <span class="n">layer_thickness</span> <span class="o">*</span> <span class="n">temperature</span>
        <span class="n">ohc</span> <span class="o">=</span> <span class="n">ohc</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ohc</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="dev_getting_started.html" class="btn btn-neutral float-left" title="Developer: Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dev_add_task.html" class="btn btn-neutral float-right" title="Developers: Adding a new analysis task" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright This software is open source software available under the BSD-3license. Copyright (c) 2022 Triad National Security, LLC. All rights reserved. Copyright (c) 2018 Lawrence Livermore National Security, LLC. All rights reserved. Copyright (c) 2018 UT-Battelle, LLC. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: develop
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../1.10.0/tutorials/dev_understand_a_task.html">1.10.0</a></dd>
      <dd><a href="../../1.11.0/tutorials/dev_understand_a_task.html">1.11.0</a></dd>
      <dd><a href="../../1.12.0/tutorials/dev_understand_a_task.html">1.12.0</a></dd>
      <dd><a href="../../1.8.0/tutorials/dev_understand_a_task.html">1.8.0</a></dd>
      <dd><a href="../../1.9.0/tutorials/dev_understand_a_task.html">1.9.0</a></dd>
      <dd><a href="../../1.9.1/tutorials/dev_understand_a_task.html">1.9.1</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="dev_understand_a_task.html">develop</a></dd>
      <dd><a href="../../main/tutorials/dev_understand_a_task.html">main</a></dd>
    </dl>
  </div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>