

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Support Parallel Tasks &mdash; MPAS-Analysis 1.2.6 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Analysis Task Template" href="analysis_task_template.html" />
    <link rel="prev" title="Moving variable mapping outside of mpas_xarray" href="variable_mapping_reorg.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> MPAS-Analysis
          

          
          </a>

          
            
            
              <div class="version">
                1.2.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analysis_tasks.html">Analysis Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components.html">MPAS Components and E3SM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observations.html">Observations</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../design_docs.html">Design Documents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="generalized_horizontal_interpolation.html">Generalized Horizontal Interpolation in MPAS-Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_file_reorganization.html">Config File Reorganization</a></li>
<li class="toctree-l2"><a class="reference internal" href="timekeeping_reorg.html">Reorganize Timekeeping</a></li>
<li class="toctree-l2"><a class="reference internal" href="generalize_calendar.html">Generalize Calendar supported by Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="variable_mapping_reorg.html">Moving variable mapping outside of mpas_xarray</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Support Parallel Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysis_task_template.html">Analysis Task Template</a></li>
<li class="toctree-l2"><a class="reference internal" href="remapper.html">Remapper for “online” remapping of data sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="prerequisite_tasks.html">Prerequisite Tasks and Subtasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="eddykineticenergy.html">Eddy Kinetic Energy Climatology Mapping</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Main Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html#contributors">Contributors</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MPAS-Analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../design_docs.html">Design Documents</a> &raquo;</li>
        
      <li>Support Parallel Tasks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/design_docs/parallel_tasks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="support-parallel-tasks">
<h1>Support Parallel Tasks<a class="headerlink" href="#support-parallel-tasks" title="Permalink to this headline">¶</a></h1>
<p><span class="raw-html-m2r"><h2>
Xylar Asay-Davis <br>
date: 2017/02/22 <br>
</h2></span></p>
<h3> Summary </h3><p>Currently, the full analysis suite includes 7 tasks, 5 for the ocean and 2 for sea ice.
The number of tasks is expected to grow over time.  Task parallelism in some
form is needed to allow as many tasks as desired to be run simultaneiously.
Successful completion of this design will mean that the analysis suite produces
identical results to the current <code class="docutils literal notranslate"><span class="pre">develop</span></code> branch but that several analysis
tasks (a number selected by the user) run simultaneously.</p>
<h3> Requirements </h3><h4> Requirement: Tasks run simultaneously <br>
Date last modified: 2017/02/22 <br>
Contributors: Xylar Asay-Davis
</h4>
There must be a mechanism for running more than one analysis task simultaneously.

<h4> Requirement: Select maximum number of tasks <br>
Date last modified: 2017/02/22 <br>
Contributors: Xylar Asay-Davis
</h4>
There must be a mechanism for the user to select the maximum number of tasks
to run simultaneously.  This might be necessary to control the number of processors
or the amount of memory used on a given machine or (in the case of running
analysis on login nodes) to be nice to other users on a shared resource.

<h4> Requirement: Lock files written by multiple tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4>
There must be a mechanism for locking files (during either reading or writing) if
they can be written by multiple tasks.  This is necessary to prevent cases where
multiple tasks write to the same file simultaneously or one task reads from a file
at the same time another is writing.

<h4> Consideration: Task parallelism should work on either login or compute nodes <br>
Date last modified: 2017/02/22 <br>
Contributors: Xylar Asay-Davis
</h4>
On some systems, care needs to be taken that scripts run on the compute nodes
rather than on the management node(s).  For example, on Edison and Cori, the
`aprun` command is required to ensure that scripts run on compute nodes.

<h4> Consideration: There may need to be a way to limit the memory used by a task <br>
Date last modified: 2017/02/22 <br>
Contributors: Phillip J. Wolfram, Xylar Asay-Davis
</h4>
It may be that `xarray-dask` with subprocess (or similar) may need to be some
initialization of xarray corresponding to reduced memory available.  For example,
with 10 processes on a node, `xarray` / `dask` should be initialized to use only
1/10th of the memory and CPUs per task. `xarray-dask` may require special
initialization for efficiency and to avoid crashes.

<h3> Algorithmic Formulations </h3>

<h4> Design solution: Tasks run simultaneously <br>
Date last modified: 2017/02/23 <br>
Contributors: Xylar Asay-Davis
</h4><p>I propose to have a config option, <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code>, that is the number of concurrent
tasks that are to be performed. If this flag is set to a number greater than 1, analysis
tasks will run concurrently.  To accomplish this, I propose to use <code class="docutils literal notranslate"><span class="pre">subprocess.call</span></code> or
one of its variants within <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code>to call itself but with only one task at a
time.  Thus, if <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code> gets called with only a single task (whether directly
from the command line or through <code class="docutils literal notranslate"><span class="pre">subprocess.call</span></code>), it would execute that task without
spawning additional subprocesses.</p>
<p>This approach would require having a method for creating a list of individual tasks
to be performed, launching <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code> of those tasks, and then waiting for
them to complete, launching additional tasks as previous tasks complete.  The approach
would also require individual log files for each task, each stored in the log directory
(already a config option).</p>
<h4> Design solution: Select maximum number of tasks <br>
Date last modified: 2017/02/23 <br>
Contributors: Xylar Asay-Davis
</h4><p>This is accomplished with the <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code> flag above.  A value of
<code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span> <span class="pre">=</span> <span class="pre">1</span></code> would indicate serial execution, though likely still
via launching subprocesses for each task.</p>
<p>The command <code class="docutils literal notranslate"><span class="pre">subprocess.Popen</span></code> allows enough flexibility that it will be possible
to launch several jobs, andthen to farm out additional jobs as each returns. It should
be possible to use a combination of <code class="docutils literal notranslate"><span class="pre">os.kill(pid,</span> <span class="pre">0)</span></code>, which checks if a
process is running, and <code class="docutils literal notranslate"><span class="pre">os.waitpid(-1,0)</span></code>, which waits for any subprocess to finish,
to accomplish launching several processes and waiting until the first one finishes
before launching the next task, or in pseudo-code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">processes</span> <span class="o">=</span> <span class="n">launchTasks</span><span class="p">(</span><span class="n">taskNames</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">taskCount</span><span class="p">])</span>
<span class="n">remainingTasks</span> <span class="o">=</span> <span class="n">taskNames</span><span class="p">[</span><span class="n">taskCount</span><span class="p">:]</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">waitForTask</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span>
    <span class="n">processes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remainingTasks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">launchTasks</span><span class="p">(</span><span class="n">remainingTasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">proceses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="n">remainingTasks</span> <span class="o">=</span> <span class="n">remainingTasks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
<p>Output from the main <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code> task will list which analysis tasks were run
and which completed successfully.  The full analysis will exit with an error if one
task fails, but only after attempting to run all desired analysis tasks.  This allows
the failure of one analysis task not to interrupt execution of other analyses.</p>
<p>In a future PR, this work can be expanded to include checking if the appropriate
analysis member (AM) was turned on during the run and skipping any analysis tasks that
depend on that AM if not (Issue #58).</p>
<h4> Design solution: Lock files written by multiple tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>Teh design solution is based on the process lock in the fasteners package:
<a class="reference external" href="http://fasteners.readthedocs.io/en/latest/examples.html#interprocess-locks">http://fasteners.readthedocs.io/en/latest/examples.html#interprocess-locks</a></p>
<p>Currently, only mapping files should be written by multiple tasks, requiring locks.</p>
<p>The algorithm consists of 2 changes.  First, I removed the option <code class="docutils literal notranslate"><span class="pre">overwriteMappingFiles</span></code>,
which is now always <code class="docutils literal notranslate"><span class="pre">False</span></code>—if a mapping file exists, it is not overwritten.  This
was necessary because now only one task will write a given mapping file if it doesn’t
already exist and the other tasks will wait for it to be written.  Then, all tasks
know there is a valid mapping file that they can read without having to lock the file.</p>
<p>The second change was to add a lock around the subprocess call to <code class="docutils literal notranslate"><span class="pre">ESMF_RegridWeightGen</span></code>
that make sure only one process generates the mapping file.  Each process attempts to
acquire the lock and checks if the mapping file already exists once it acquires the
lock.  If not, it generates the mapping file and releases the lock.  If so, it just
releases the lock and moves on.  Thus, only the first process to acquire the lock
generates the mapping file and the others wait until it is finished.</p>
<h4> Design solution: Task parallelism should work on either login or compute nodes <br>
Date last modified: 2017/02/23 <br>
Contributors: Xylar Asay-Davis
</h4>
For the time being, I propose to address only task parallelism on the login nodes and to
extend the parallelism to work robustly on compute nodes as a separate project.
Nevertheless, I will seek to implement this design in a way that should be conducive to
this later extension.  Likely what will be required is a robust way of adding a prefix
to the commandline (e.g. `aprun -np 1`) when calling subprocesses.  Adding such a prefix
should be relatively simple.

<h4> Design solution: There may need to be a way to limit the memory used by a task <br>
Date last modified: 2017/02/23 <br>
Contributors: Xylar Asay-Davis
</h4>
I am not very familiar with `dask` within `xarray` and I do not intend to address this
consideration directly in this project.  However, on my brief investigation, it seems like
the proper way to handle this may be to have a `chunk` config option either for all tasks
or for individual tasks that can be used to control the size of data in memory. I think
such an approach can be investigated in parallel to this project.  An intermediate solution
for situations where memory is limited would be to set `parallelTaskCount` to a small number.


<h3> Design and Implementation </h3>

This design has been implemented in the test branch https://github.com/xylar/MPAS-Analysis/tree/parallel_tasks

<h4> Implementation: Tasks run simultaneously <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>Tasks can now run in parallel.  This has been implemented in these 4 functions within <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_parallel_tasks</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">analyses</span><span class="p">,</span> <span class="n">configFiles</span><span class="p">,</span> <span class="n">taskCount</span><span class="p">):</span>
    <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run this script once each for several parallel tasks.</span>

<span class="sd">    Author: Xylar Asay-Davis</span>
<span class="sd">    Last Modified: 03/08/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">taskNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">analysisModule</span><span class="o">.</span><span class="n">get_task_name</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span>
                 <span class="n">analysisModule</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">analyses</span><span class="p">]</span>

    <span class="n">taskCount</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">taskCount</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">taskNames</span><span class="p">))</span>

    <span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">logs</span><span class="p">)</span> <span class="o">=</span> <span class="n">launch_tasks</span><span class="p">(</span><span class="n">taskNames</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">taskCount</span><span class="p">],</span> <span class="n">config</span><span class="p">,</span>
                                     <span class="n">configFiles</span><span class="p">)</span>
    <span class="n">remainingTasks</span> <span class="o">=</span> <span class="n">taskNames</span><span class="p">[</span><span class="n">taskCount</span><span class="p">:]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">(</span><span class="n">taskName</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span> <span class="o">=</span> <span class="n">wait_for_task</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Task {} has finished successfully.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taskName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;ERROR in task {}.  See log file {} for details&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">taskName</span><span class="p">,</span> <span class="n">logs</span><span class="p">[</span><span class="n">taskName</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">logs</span><span class="p">[</span><span class="n">taskName</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># remove the process from the process dictionary (no need to bother)</span>
        <span class="n">processes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">taskName</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remainingTasks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span> <span class="o">=</span> <span class="n">launch_tasks</span><span class="p">(</span><span class="n">remainingTasks</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">config</span><span class="p">,</span>
                                          <span class="n">configFiles</span><span class="p">)</span>
            <span class="c1"># merge the new process and log into these dictionaries</span>
            <span class="n">processes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
            <span class="n">logs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
            <span class="n">remainingTasks</span> <span class="o">=</span> <span class="n">remainingTasks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># }}}</span>


<span class="k">def</span> <span class="nf">launch_tasks</span><span class="p">(</span><span class="n">taskNames</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">configFiles</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Launch one or more tasks</span>

<span class="sd">    Author: Xylar Asay-Davis</span>
<span class="sd">    Last Modified: 03/08/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thisFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

    <span class="n">logsDirectory</span> <span class="o">=</span> <span class="n">build_config_full_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;logsSubdirectory&#39;</span><span class="p">)</span>
    <span class="n">make_directories</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">)</span>

    <span class="n">commandPrefix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getWithDefault</span><span class="p">(</span><span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="s1">&#39;commandPrefix&#39;</span><span class="p">,</span>
                                          <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">commandPrefix</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">commandPrefix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">commandPrefix</span> <span class="o">=</span> <span class="n">commandPrefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">processes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">taskName</span> <span class="ow">in</span> <span class="n">taskNames</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">commandPrefix</span> <span class="o">+</span> <span class="p">[</span><span class="n">thisFile</span><span class="p">,</span> <span class="s1">&#39;--generate&#39;</span><span class="p">,</span> <span class="n">taskName</span><span class="p">]</span> <span class="o">+</span> <span class="n">configFiles</span>

        <span class="n">logFileName</span> <span class="o">=</span> <span class="s1">&#39;{}/{}.log&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logsDirectory</span><span class="p">,</span> <span class="n">taskName</span><span class="p">)</span>

        <span class="c1"># write the command to the log file</span>
        <span class="n">logFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logFileName</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">logFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Command: {}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
        <span class="c1"># make sure the command gets written before the rest of the log</span>
        <span class="n">logFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">print</span> <span class="s1">&#39;Running {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taskName</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">logFile</span><span class="p">,</span>
                                   <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">processes</span><span class="p">[</span><span class="n">taskName</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>
        <span class="n">logs</span><span class="p">[</span><span class="n">taskName</span><span class="p">]</span> <span class="o">=</span> <span class="n">logFile</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">logs</span><span class="p">)</span>  <span class="c1"># }}}</span>


<span class="k">def</span> <span class="nf">wait_for_task</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for the next process to finish and check its status.  Returns both the</span>
<span class="sd">    task name and the process that finished.</span>

<span class="sd">    Author: Xylar Asay-Davis</span>
<span class="sd">    Last Modified: 03/08/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># first, check if any process has already finished</span>
    <span class="k">for</span> <span class="n">taskName</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>  <span class="c1"># python 2.7!</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">(</span><span class="n">process</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">taskName</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>

    <span class="c1"># No process has already finished, so wait for the next one</span>
    <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">taskName</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">status</span>
            <span class="c1"># since we used waitpid, this won&#39;t happen automatically</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">taskName</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>  <span class="c1"># }}}</span>


<span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>  <span class="c1"># {{{</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns whether a given process is currently running</span>

<span class="sd">    Author: Xylar Asay-Davis</span>
<span class="sd">    Last Modified: 03/08/2017</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>  <span class="c1"># }}}</span>
</pre></div>
</div>
<h4> Implementation: Select maximum number of tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>There is a configuration option, <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code>, which defaults to 1, meaning tasks run in serial:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[execute]</span>
<span class="c1">## options related to executing parallel tasks</span>

<span class="c1"># the number of parallel tasks (1 means tasks run in serial, the default)</span>
<span class="na">parallelTaskCount</span> <span class="o">=</span> <span class="s">8</span>
</pre></div>
</div>
<h4> Implementation: Lock files written by multiple tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>Here is the code for locking the mapping file within <code class="docutils literal notranslate"><span class="pre">shared.interpolation.interpolate</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fasteners</span>
<span class="o">...</span>
<span class="c1"># lock the weights file in case it is being written by another process</span>
<span class="k">with</span> <span class="n">fasteners</span><span class="o">.</span><span class="n">InterProcessLock</span><span class="p">(</span><span class="n">_get_lock_path</span><span class="p">(</span><span class="n">outWeightFileName</span><span class="p">)):</span>
    <span class="c1"># make sure another process didn&#39;t already create the mapping file in</span>
    <span class="c1"># the meantime</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outWeightFileName</span><span class="p">):</span>
        <span class="c1"># make sure any output is flushed before we add output from the</span>
        <span class="c1"># subprocess</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<h4> Implementation: Task parallelism should work on either login or compute nodes <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>I have included a config option <code class="docutils literal notranslate"><span class="pre">commandPrefix</span></code> that <em>should</em> be able to be used to
run the analysis on compute nodes.  If the command prefix is empty, the code should run
as normal on the compute nodes.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[execute]</span>
<span class="c1">## options related to executing parallel tasks</span>

<span class="c1"># the number of parallel tasks (1 means tasks run in serial, the default)</span>
<span class="na">parallelTaskCount</span> <span class="o">=</span> <span class="s">1</span>

<span class="c1"># Prefix on the commnd line before a parallel task (e.g. &#39;srun -n 1 python&#39;)</span>
<span class="c1"># Default is no prefix (run_analysis.py is executed directly)</span>
<span class="na">commandPrefix</span> <span class="o">=</span> <span class="s">srun -n 1</span>
</pre></div>
</div>
<h4> Implementation: There may need to be a way to limit the memory used by a task <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>As mentioned above, I have not addressed this consideration in this project.  Currently,
the suggested approach would be to limit <code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span></code> to a number of tasks that
does not cause memory problems.  More sophisticated approaches could be explored in the
future.</p>
<h3> Testing </h3><h4> Testing and Validation: Tasks run simultaneously <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>So far, I have tested extensively on my laptop (<code class="docutils literal notranslate"><span class="pre">parallelTaskCount</span> <span class="pre">=</span> <span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">4</span></code> and <code class="docutils literal notranslate"><span class="pre">8</span></code>)
with the expected results. Later, I will test on Edison and Wolf as well.</p>
<h4> Testing and Validation: Select maximum number of tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>Same as above.</p>
<h4> Implementation: Lock files written by multiple tasks <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>I ran multiple climatology map tasks at the same time and verified from the log files
that only one created each mapping file.  Others must have waited for that file to be
written or they would have crashed almost immediately when they tried to read the
mapping file during remapping operations.  So I’m confident the code is working as
intended.</p>
<h4> Testing and Validation: Task parallelism should work on either login or compute nodes <br>
Date last modified: 2017/03/10<br>
Contributors: Xylar Asay-Davis
</h4><p>On Edison and Wolf, I will test running the analysis with parallel tasks both on login nodes
and by submitting a job to run on the compute nodes (using the appropriate <code class="docutils literal notranslate"><span class="pre">commandPrefix</span></code>).</p>
<h4> Testing and Validation: There may need to be a way to limit the memory used by a task <br>
Date last modified: 2017/03/10 <br>
Contributors: Xylar Asay-Davis
</h4><p>Assuming no crashes in my testing on compute nodes with all tasks running in parallel, I will
leave this consideration for investigation in the future.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="analysis_task_template.html" class="btn btn-neutral float-right" title="Analysis Task Template" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="variable_mapping_reorg.html" class="btn btn-neutral float-left" title="Moving variable mapping outside of mpas_xarray" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright This software is open source software available under the BSD-3license. Copyright (c) 2019 Triad National Security, LLC. All rights reserved. Copyright (c) 2018 Lawrence Livermore National Security, LLC. All rights reserved. Copyright (c) 2018 UT-Battelle, LLC. All rights reserved.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>